

============================== 2022-04-20 03:41:56.553121 | c0a6d77c-ea4a-424e-9c93-69e640477030 ==============================
03:41:56.553121 [info ] [MainThread]: Running with dbt=1.0.4
03:41:56.554039 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, config_dir=False, defer=None, state=None, cls=<class 'dbt.task.debug.DebugTask'>, which='debug', rpc_method=None)
03:41:56.555475 [debug] [MainThread]: Tracking: tracking
03:41:56.561712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa8fba06880>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa8fba064c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa8fba06ac0>]}
03:41:56.993956 [debug] [MainThread]: Executing "git --help"
03:41:57.001030 [debug] [MainThread]: STDOUT: "b"usage: git [--version] [--help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone             Clone a repository into a new directory\n   init              Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add               Add file contents to the index\n   mv                Move or rename a file, a directory, or a symlink\n   restore           Restore working tree files\n   rm                Remove files from the working tree and from the index\n   sparse-checkout   Initialize and modify the sparse-checkout\n\nexamine the history and state (see also: git help revisions)\n   bisect            Use binary search to find the commit that introduced a bug\n   diff              Show changes between commits, commit and working tree, etc\n   grep              Print lines matching a pattern\n   log               Show commit logs\n   show              Show various types of objects\n   status            Show the working tree status\n\ngrow, mark and tweak your common history\n   branch            List, create, or delete branches\n   commit            Record changes to the repository\n   merge             Join two or more development histories together\n   rebase            Reapply commits on top of another base tip\n   reset             Reset current HEAD to the specified state\n   switch            Switch branches\n   tag               Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch             Download objects and refs from another repository\n   pull              Fetch from and integrate with another repository or a local branch\n   push              Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
03:41:57.002275 [debug] [MainThread]: STDERR: "b''"
03:41:57.009898 [debug] [MainThread]: Acquiring new snowflake connection "debug"
03:41:57.013415 [debug] [MainThread]: Using snowflake connection "debug"
03:41:57.014351 [debug] [MainThread]: On debug: select 1 as id
03:41:57.015562 [debug] [MainThread]: Opening a new connection, currently in state init
03:41:58.027135 [debug] [MainThread]: SQL status: SUCCESS 1 in 1.01 seconds
03:41:58.031443 [debug] [MainThread]: On debug: Close
03:41:58.168075 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa8fb9dd940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa8fb9ddca0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa8f587f9d0>]}
03:41:59.096581 [debug] [MainThread]: Connection 'debug' was properly closed.


============================== 2022-04-20 03:51:15.768002 | 31e37258-6428-4764-9087-1044673dc5df ==============================
03:51:15.768002 [info ] [MainThread]: Running with dbt=1.0.4
03:51:15.771269 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
03:51:15.772186 [debug] [MainThread]: Tracking: tracking
03:51:15.774161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb5a8e2250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb5a8e2cd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb5a8e2460>]}
03:51:15.796638 [info ] [MainThread]: Partial parse save file not found. Starting full parse.
03:51:15.797982 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '31e37258-6428-4764-9087-1044673dc5df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb5a8e26a0>]}
03:51:15.823859 [debug] [MainThread]: Parsing macros/adapters.sql
03:51:15.894338 [debug] [MainThread]: Parsing macros/catalog.sql
03:51:15.898313 [debug] [MainThread]: Parsing macros/materializations/seed.sql
03:51:15.908003 [debug] [MainThread]: Parsing macros/materializations/incremental.sql
03:51:15.921467 [debug] [MainThread]: Parsing macros/materializations/merge.sql
03:51:15.928118 [debug] [MainThread]: Parsing macros/materializations/view.sql
03:51:15.930816 [debug] [MainThread]: Parsing macros/materializations/table.sql
03:51:15.936711 [debug] [MainThread]: Parsing macros/materializations/snapshot.sql
03:51:15.939175 [debug] [MainThread]: Parsing macros/materializations/configs.sql
03:51:15.943566 [debug] [MainThread]: Parsing macros/materializations/hooks.sql
03:51:15.949914 [debug] [MainThread]: Parsing macros/materializations/snapshots/strategies.sql
03:51:15.975859 [debug] [MainThread]: Parsing macros/materializations/snapshots/helpers.sql
03:51:15.995392 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot_merge.sql
03:51:15.999400 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot.sql
03:51:16.018485 [debug] [MainThread]: Parsing macros/materializations/tests/test.sql
03:51:16.026993 [debug] [MainThread]: Parsing macros/materializations/tests/helpers.sql
03:51:16.030828 [debug] [MainThread]: Parsing macros/materializations/tests/where_subquery.sql
03:51:16.034275 [debug] [MainThread]: Parsing macros/materializations/seeds/seed.sql
03:51:16.045164 [debug] [MainThread]: Parsing macros/materializations/seeds/helpers.sql
03:51:16.072112 [debug] [MainThread]: Parsing macros/materializations/models/view/create_view_as.sql
03:51:16.077093 [debug] [MainThread]: Parsing macros/materializations/models/view/helpers.sql
03:51:16.080038 [debug] [MainThread]: Parsing macros/materializations/models/view/view.sql
03:51:16.094648 [debug] [MainThread]: Parsing macros/materializations/models/view/create_or_replace_view.sql
03:51:16.099558 [debug] [MainThread]: Parsing macros/materializations/models/incremental/on_schema_change.sql
03:51:16.126687 [debug] [MainThread]: Parsing macros/materializations/models/incremental/incremental.sql
03:51:16.144029 [debug] [MainThread]: Parsing macros/materializations/models/incremental/merge.sql
03:51:16.163302 [debug] [MainThread]: Parsing macros/materializations/models/incremental/column_helpers.sql
03:51:16.171432 [debug] [MainThread]: Parsing macros/materializations/models/incremental/is_incremental.sql
03:51:16.174730 [debug] [MainThread]: Parsing macros/materializations/models/table/create_table_as.sql
03:51:16.180097 [debug] [MainThread]: Parsing macros/materializations/models/table/table.sql
03:51:16.192328 [debug] [MainThread]: Parsing macros/generic_test_sql/not_null.sql
03:51:16.194255 [debug] [MainThread]: Parsing macros/generic_test_sql/unique.sql
03:51:16.196009 [debug] [MainThread]: Parsing macros/generic_test_sql/accepted_values.sql
03:51:16.198575 [debug] [MainThread]: Parsing macros/generic_test_sql/relationships.sql
03:51:16.200499 [debug] [MainThread]: Parsing macros/etc/datetime.sql
03:51:16.213532 [debug] [MainThread]: Parsing macros/etc/statement.sql
03:51:16.221153 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_alias.sql
03:51:16.223747 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_schema.sql
03:51:16.228077 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_database.sql
03:51:16.230949 [debug] [MainThread]: Parsing macros/adapters/schema.sql
03:51:16.235085 [debug] [MainThread]: Parsing macros/adapters/indexes.sql
03:51:16.239465 [debug] [MainThread]: Parsing macros/adapters/metadata.sql
03:51:16.250808 [debug] [MainThread]: Parsing macros/adapters/persist_docs.sql
03:51:16.258513 [debug] [MainThread]: Parsing macros/adapters/freshness.sql
03:51:16.263591 [debug] [MainThread]: Parsing macros/adapters/relation.sql
03:51:16.278241 [debug] [MainThread]: Parsing macros/adapters/columns.sql
03:51:16.293690 [debug] [MainThread]: Parsing tests/generic/builtin.sql
03:51:16.579812 [debug] [MainThread]: 1699: static parser successfully parsed legacy/customer_orders.sql
03:51:16.631224 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.dbt_refactoring.example

03:51:16.640291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '31e37258-6428-4764-9087-1044673dc5df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb59784cd0>]}
03:51:16.664862 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '31e37258-6428-4764-9087-1044673dc5df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb5a8cdf40>]}
03:51:16.666008 [info ] [MainThread]: Found 1 model, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 0 sources, 0 exposures, 0 metrics
03:51:16.668371 [info ] [MainThread]: 
03:51:16.670763 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:51:16.673837 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
03:51:16.694146 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
03:51:16.695150 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
03:51:16.696938 [debug] [ThreadPool]: Opening a new connection, currently in state init
03:51:17.647763 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 0.95 seconds
03:51:17.651269 [debug] [ThreadPool]: On list_analytics: Close
03:51:17.794096 [debug] [ThreadPool]: Acquiring new snowflake connection "create_analytics_dbt_knguyen_refactor"
03:51:17.796170 [debug] [ThreadPool]: Acquiring new snowflake connection "create_analytics_dbt_knguyen_refactor"
03:51:17.798078 [debug] [ThreadPool]: Creating schema "_ReferenceKey(database='analytics', schema='dbt_knguyen_refactor', identifier=None)"
03:51:17.813353 [debug] [ThreadPool]: Using snowflake connection "create_analytics_dbt_knguyen_refactor"
03:51:17.814642 [debug] [ThreadPool]: On create_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "create_analytics_dbt_knguyen_refactor"} */
create schema if not exists analytics.dbt_knguyen_refactor
03:51:17.816541 [debug] [ThreadPool]: Opening a new connection, currently in state closed
03:51:18.486243 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.67 seconds
03:51:18.489449 [debug] [ThreadPool]: On create_analytics_dbt_knguyen_refactor: Close
03:51:18.628043 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
03:51:18.641554 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
03:51:18.642967 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
03:51:18.644189 [debug] [ThreadPool]: Opening a new connection, currently in state closed
03:51:19.197554 [debug] [ThreadPool]: SQL status: SUCCESS 0 in 0.55 seconds
03:51:19.201575 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
03:51:19.352781 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
03:51:19.354504 [info ] [MainThread]: 
03:51:19.363499 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.customer_orders
03:51:19.366364 [info ] [Thread-1  ]: 1 of 1 START view model dbt_knguyen_refactor.customer_orders.................... [RUN]
03:51:19.368530 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.customer_orders"
03:51:19.369377 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.customer_orders
03:51:19.371286 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.customer_orders
03:51:19.375286 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.customer_orders"
03:51:19.392701 [debug] [Thread-1  ]: finished collecting timing info
03:51:19.393976 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.customer_orders
03:51:19.434690 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.customer_orders"
03:51:19.456235 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.customer_orders"
03:51:19.456956 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.customer_orders 
  
   as (
    select 
    orders.id as order_id,
    orders.user_id as customer_id,
    last_name as surname,
    first_name as givenname,
    first_order_date,
    order_count,
    total_lifetime_value,
    round(amount/100.0,2) as order_value_dollars,
    orders.status as order_status,
    payments.status as payment_status
from raw.jaffle_shop.orders as orders

join (
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
) customers
on orders.user_id = customers.id

join (

    select 
        b.id as customer_id,
        b.name as full_name,
        b.last_name as surname,
        b.first_name as givenname,
        min(order_date) as first_order_date,
        min(case when a.status NOT IN ('returned','return_pending') then order_date end) as first_non_returned_order_date,
        max(case when a.status NOT IN ('returned','return_pending') then order_date end) as most_recent_non_returned_order_date,
        COALESCE(max(user_order_seq),0) as order_count,
        COALESCE(count(case when a.status != 'returned' then 1 end),0) as non_returned_order_count,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end) as total_lifetime_value,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end)/NULLIF(count(case when a.status NOT IN ('returned','return_pending') then 1 end),0) as avg_non_returned_order_value,
        array_agg(distinct a.id) as order_ids

    from (
      select 
        row_number() over (partition by user_id order by order_date, id) as user_order_seq,
        *
      from raw.jaffle_shop.orders
    ) a

    join ( 
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
    ) b
    on a.user_id = b.id

    left outer join raw.stripe.payment c
    on a.id = c.orderid

    where a.status NOT IN ('pending') and c.status != 'fail'

    group by b.id, b.name, b.last_name, b.first_name

) customer_order_history
on orders.user_id = customer_order_history.customer_id

left outer join raw.stripe.payment payments
on orders.id = payments.orderid

where payments.status != 'fail'
  );
03:51:19.458556 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
03:51:20.188279 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.73 seconds
03:51:20.200017 [debug] [Thread-1  ]: finished collecting timing info
03:51:20.200941 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: Close
03:51:20.363397 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '31e37258-6428-4764-9087-1044673dc5df', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb581127c0>]}
03:51:20.365472 [info ] [Thread-1  ]: 1 of 1 OK created view model dbt_knguyen_refactor.customer_orders............... [[32mSUCCESS 1[0m in 1.00s]
03:51:20.367382 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.customer_orders
03:51:20.372621 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:51:20.374771 [info ] [MainThread]: 
03:51:20.376173 [info ] [MainThread]: Finished running 1 view model in 3.70s.
03:51:20.378197 [debug] [MainThread]: Connection 'master' was properly closed.
03:51:20.379402 [debug] [MainThread]: Connection 'model.dbt_refactoring.customer_orders' was properly closed.
03:51:20.395826 [info ] [MainThread]: 
03:51:20.397504 [info ] [MainThread]: [32mCompleted successfully[0m
03:51:20.400021 [info ] [MainThread]: 
03:51:20.401926 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
03:51:20.404910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb5a82e910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb597847f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ffb58112d60>]}


============================== 2022-04-20 04:23:27.491341 | 4a299094-9059-4899-9027-723e81fd71fb ==============================
04:23:27.491341 [info ] [MainThread]: Running with dbt=1.0.4
04:23:27.495227 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
04:23:27.497163 [debug] [MainThread]: Tracking: tracking
04:23:27.499628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd17083c430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd17083c8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd17083ca60>]}
04:23:27.533075 [info ] [MainThread]: Unable to do partial parsing because a project config has changed
04:23:27.535430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '4a299094-9059-4899-9027-723e81fd71fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd17083ca30>]}
04:23:27.565209 [debug] [MainThread]: Parsing macros/adapters.sql
04:23:27.638981 [debug] [MainThread]: Parsing macros/catalog.sql
04:23:27.644174 [debug] [MainThread]: Parsing macros/materializations/seed.sql
04:23:27.653328 [debug] [MainThread]: Parsing macros/materializations/incremental.sql
04:23:27.667335 [debug] [MainThread]: Parsing macros/materializations/merge.sql
04:23:27.674500 [debug] [MainThread]: Parsing macros/materializations/view.sql
04:23:27.677432 [debug] [MainThread]: Parsing macros/materializations/table.sql
04:23:27.682811 [debug] [MainThread]: Parsing macros/materializations/snapshot.sql
04:23:27.684843 [debug] [MainThread]: Parsing macros/materializations/configs.sql
04:23:27.688877 [debug] [MainThread]: Parsing macros/materializations/hooks.sql
04:23:27.695988 [debug] [MainThread]: Parsing macros/materializations/snapshots/strategies.sql
04:23:27.722756 [debug] [MainThread]: Parsing macros/materializations/snapshots/helpers.sql
04:23:27.741947 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot_merge.sql
04:23:27.745654 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot.sql
04:23:27.764914 [debug] [MainThread]: Parsing macros/materializations/tests/test.sql
04:23:27.773395 [debug] [MainThread]: Parsing macros/materializations/tests/helpers.sql
04:23:27.776757 [debug] [MainThread]: Parsing macros/materializations/tests/where_subquery.sql
04:23:27.780953 [debug] [MainThread]: Parsing macros/materializations/seeds/seed.sql
04:23:27.791327 [debug] [MainThread]: Parsing macros/materializations/seeds/helpers.sql
04:23:27.818229 [debug] [MainThread]: Parsing macros/materializations/models/view/create_view_as.sql
04:23:27.823375 [debug] [MainThread]: Parsing macros/materializations/models/view/helpers.sql
04:23:27.825995 [debug] [MainThread]: Parsing macros/materializations/models/view/view.sql
04:23:27.837279 [debug] [MainThread]: Parsing macros/materializations/models/view/create_or_replace_view.sql
04:23:27.842183 [debug] [MainThread]: Parsing macros/materializations/models/incremental/on_schema_change.sql
04:23:27.868412 [debug] [MainThread]: Parsing macros/materializations/models/incremental/incremental.sql
04:23:27.885288 [debug] [MainThread]: Parsing macros/materializations/models/incremental/merge.sql
04:23:27.904555 [debug] [MainThread]: Parsing macros/materializations/models/incremental/column_helpers.sql
04:23:27.912091 [debug] [MainThread]: Parsing macros/materializations/models/incremental/is_incremental.sql
04:23:27.915246 [debug] [MainThread]: Parsing macros/materializations/models/table/create_table_as.sql
04:23:27.920248 [debug] [MainThread]: Parsing macros/materializations/models/table/table.sql
04:23:27.932194 [debug] [MainThread]: Parsing macros/generic_test_sql/not_null.sql
04:23:27.933836 [debug] [MainThread]: Parsing macros/generic_test_sql/unique.sql
04:23:27.935798 [debug] [MainThread]: Parsing macros/generic_test_sql/accepted_values.sql
04:23:27.939080 [debug] [MainThread]: Parsing macros/generic_test_sql/relationships.sql
04:23:27.941482 [debug] [MainThread]: Parsing macros/etc/datetime.sql
04:23:27.955319 [debug] [MainThread]: Parsing macros/etc/statement.sql
04:23:27.963327 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_alias.sql
04:23:27.966189 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_schema.sql
04:23:27.970307 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_database.sql
04:23:27.973713 [debug] [MainThread]: Parsing macros/adapters/schema.sql
04:23:27.978292 [debug] [MainThread]: Parsing macros/adapters/indexes.sql
04:23:27.982742 [debug] [MainThread]: Parsing macros/adapters/metadata.sql
04:23:27.994276 [debug] [MainThread]: Parsing macros/adapters/persist_docs.sql
04:23:28.001525 [debug] [MainThread]: Parsing macros/adapters/freshness.sql
04:23:28.006640 [debug] [MainThread]: Parsing macros/adapters/relation.sql
04:23:28.022245 [debug] [MainThread]: Parsing macros/adapters/columns.sql
04:23:28.039682 [debug] [MainThread]: Parsing tests/generic/builtin.sql
04:23:28.330308 [debug] [MainThread]: 1699: static parser successfully parsed legacy/customer_orders.sql
04:23:28.408638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '4a299094-9059-4899-9027-723e81fd71fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd16f796910>]}
04:23:28.424189 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '4a299094-9059-4899-9027-723e81fd71fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd16eec3e50>]}
04:23:28.425565 [info ] [MainThread]: Found 1 model, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:23:28.427670 [info ] [MainThread]: 
04:23:28.429214 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:23:28.432221 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
04:23:28.455301 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
04:23:28.456595 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
04:23:28.458666 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:23:29.598045 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 1.14 seconds
04:23:29.601111 [debug] [ThreadPool]: On list_analytics: Close
04:23:29.760898 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:23:29.780240 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:23:29.782519 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:23:29.784614 [debug] [ThreadPool]: Opening a new connection, currently in state closed
04:23:30.469026 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.68 seconds
04:23:30.473708 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:23:30.642508 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:23:30.644247 [info ] [MainThread]: 
04:23:30.653387 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.customer_orders
04:23:30.654451 [info ] [Thread-1  ]: 1 of 1 START view model dbt_knguyen_refactor.customer_orders.................... [RUN]
04:23:30.656283 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.customer_orders"
04:23:30.657618 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.customer_orders
04:23:30.659621 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.customer_orders
04:23:30.668839 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.customer_orders"
04:23:30.672680 [debug] [Thread-1  ]: finished collecting timing info
04:23:30.673679 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.customer_orders
04:23:30.716296 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.customer_orders"
04:23:30.724385 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.customer_orders"
04:23:30.725375 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.customer_orders 
  
   as (
    select 
    orders.id as order_id,
    orders.user_id as customer_id,
    last_name as surname,
    first_name as givenname,
    first_order_date,
    order_count,
    total_lifetime_value,
    round(amount/100.0,2) as order_value_dollars,
    orders.status as order_status,
    payments.status as payment_status
from raw.jaffle_shop.orders as orders

join (
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
) customers
on orders.user_id = customers.id

join (

    select 
        b.id as customer_id,
        b.name as full_name,
        b.last_name as surname,
        b.first_name as givenname,
        min(order_date) as first_order_date,
        min(case when a.status NOT IN ('returned','return_pending') then order_date end) as first_non_returned_order_date,
        max(case when a.status NOT IN ('returned','return_pending') then order_date end) as most_recent_non_returned_order_date,
        COALESCE(max(user_order_seq),0) as order_count,
        COALESCE(count(case when a.status != 'returned' then 1 end),0) as non_returned_order_count,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end) as total_lifetime_value,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end)/NULLIF(count(case when a.status NOT IN ('returned','return_pending') then 1 end),0) as avg_non_returned_order_value,
        array_agg(distinct a.id) as order_ids

    from (
      select 
        row_number() over (partition by user_id order by order_date, id) as user_order_seq,
        *
      from raw.jaffle_shop.orders
    ) a

    join ( 
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
    ) b
    on a.user_id = b.id

    left outer join raw.stripe.payment c
    on a.id = c.orderid

    where a.status NOT IN ('pending') and c.status != 'fail'

    group by b.id, b.name, b.last_name, b.first_name

) customer_order_history
on orders.user_id = customer_order_history.customer_id

left outer join raw.stripe.payment payments
on orders.id = payments.orderid

where payments.status != 'fail'
  );
04:23:30.728005 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
04:23:31.376722 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.65 seconds
04:23:31.389542 [debug] [Thread-1  ]: finished collecting timing info
04:23:31.390735 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: Close
04:23:31.560080 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4a299094-9059-4899-9027-723e81fd71fb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd16ee811f0>]}
04:23:31.562206 [info ] [Thread-1  ]: 1 of 1 OK created view model dbt_knguyen_refactor.customer_orders............... [[32mSUCCESS 1[0m in 0.90s]
04:23:31.563698 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.customer_orders
04:23:31.568626 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:23:31.570250 [info ] [MainThread]: 
04:23:31.572582 [info ] [MainThread]: Finished running 1 view model in 3.14s.
04:23:31.575175 [debug] [MainThread]: Connection 'master' was properly closed.
04:23:31.578257 [debug] [MainThread]: Connection 'model.dbt_refactoring.customer_orders' was properly closed.
04:23:31.598690 [info ] [MainThread]: 
04:23:31.601194 [info ] [MainThread]: [32mCompleted successfully[0m
04:23:31.604558 [info ] [MainThread]: 
04:23:31.607375 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
04:23:31.610581 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd16ee816a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd16e01af10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd16c2a32b0>]}


============================== 2022-04-20 04:25:04.850928 | 914b3225-f2c3-4a32-be66-b0aab44504f2 ==============================
04:25:04.850928 [info ] [MainThread]: Running with dbt=1.0.4
04:25:04.854914 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, compile=True, threads=None, select=None, exclude=None, selector_name=None, state=None, defer=None, cls=<class 'dbt.task.generate.GenerateTask'>, which='generate', rpc_method='docs.generate')
04:25:04.856155 [debug] [MainThread]: Tracking: tracking
04:25:04.858647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4093c59d60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4093c59520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4093c59d00>]}
04:25:04.917330 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
04:25:04.918714 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
04:25:04.929991 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '914b3225-f2c3-4a32-be66-b0aab44504f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4092ac50d0>]}
04:25:04.949743 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '914b3225-f2c3-4a32-be66-b0aab44504f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4092b4b970>]}
04:25:04.951195 [info ] [MainThread]: Found 1 model, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:25:04.954240 [info ] [MainThread]: 
04:25:04.956516 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:25:04.958971 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:25:04.983035 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:25:04.984626 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:25:04.988192 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:25:05.772232 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.78 seconds
04:25:05.776966 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:25:05.943352 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:25:05.945381 [info ] [MainThread]: 
04:25:05.954889 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.customer_orders
04:25:05.957443 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.customer_orders"
04:25:05.958476 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.customer_orders
04:25:05.959847 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.customer_orders
04:25:05.969321 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.customer_orders"
04:25:05.972622 [debug] [Thread-1  ]: finished collecting timing info
04:25:05.973520 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.customer_orders
04:25:05.975021 [debug] [Thread-1  ]: finished collecting timing info
04:25:05.976995 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.customer_orders
04:25:05.982035 [debug] [MainThread]: Connection 'master' was properly closed.
04:25:05.982996 [debug] [MainThread]: Connection 'model.dbt_refactoring.customer_orders' was properly closed.
04:25:05.998514 [info ] [MainThread]: Done.
04:25:06.032887 [debug] [MainThread]: Acquiring new snowflake connection "generate_catalog"
04:25:06.033686 [info ] [MainThread]: Building catalog
04:25:06.037170 [debug] [ThreadPool]: Acquiring new snowflake connection "analytics.information_schema"
04:25:06.038964 [debug] [ThreadPool]: Acquiring new snowflake connection "raw.information_schema"
04:25:06.056361 [debug] [ThreadPool]: Using snowflake connection "raw.information_schema"
04:25:06.057546 [debug] [ThreadPool]: Using snowflake connection "analytics.information_schema"
04:25:06.057797 [debug] [ThreadPool]: On raw.information_schema: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "raw.information_schema"} */

    
      with tables as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",
              table_type as "table_type",
              comment as "table_comment",

              -- note: this is the _role_ that owns the table
              table_owner as "table_owner",

              'Clustering Key' as "stats:clustering_key:label",
              clustering_key as "stats:clustering_key:value",
              'The key used to cluster this table' as "stats:clustering_key:description",
              (clustering_key is not null) as "stats:clustering_key:include",

              'Row Count' as "stats:row_count:label",
              row_count as "stats:row_count:value",
              'An approximate count of rows in this table' as "stats:row_count:description",
              (row_count is not null) as "stats:row_count:include",

              'Approximate Size' as "stats:bytes:label",
              bytes as "stats:bytes:value",
              'Approximate size of the table as reported by Snowflake' as "stats:bytes:description",
              (bytes is not null) as "stats:bytes:include",

              'Last Modified' as "stats:last_modified:label",
              to_varchar(convert_timezone('UTC', last_altered), 'yyyy-mm-dd HH24:MI'||'UTC') as "stats:last_modified:value",
              'The timestamp for last update/change' as "stats:last_modified:description",
              (last_altered is not null and table_type='BASE TABLE') as "stats:last_modified:include"

          from raw.INFORMATION_SCHEMA.tables

      ),

      columns as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",

              column_name as "column_name",
              ordinal_position as "column_index",
              data_type as "column_type",
              comment as "column_comment"

          from raw.INFORMATION_SCHEMA.columns
      )

      select *
      from tables
      join columns using ("table_database", "table_schema", "table_name")
      where (upper("table_schema") = upper('jaffle_shop') or upper("table_schema") = upper('stripe'))
      order by "column_index"
04:25:06.058637 [debug] [ThreadPool]: On analytics.information_schema: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "analytics.information_schema"} */

    
      with tables as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",
              table_type as "table_type",
              comment as "table_comment",

              -- note: this is the _role_ that owns the table
              table_owner as "table_owner",

              'Clustering Key' as "stats:clustering_key:label",
              clustering_key as "stats:clustering_key:value",
              'The key used to cluster this table' as "stats:clustering_key:description",
              (clustering_key is not null) as "stats:clustering_key:include",

              'Row Count' as "stats:row_count:label",
              row_count as "stats:row_count:value",
              'An approximate count of rows in this table' as "stats:row_count:description",
              (row_count is not null) as "stats:row_count:include",

              'Approximate Size' as "stats:bytes:label",
              bytes as "stats:bytes:value",
              'Approximate size of the table as reported by Snowflake' as "stats:bytes:description",
              (bytes is not null) as "stats:bytes:include",

              'Last Modified' as "stats:last_modified:label",
              to_varchar(convert_timezone('UTC', last_altered), 'yyyy-mm-dd HH24:MI'||'UTC') as "stats:last_modified:value",
              'The timestamp for last update/change' as "stats:last_modified:description",
              (last_altered is not null and table_type='BASE TABLE') as "stats:last_modified:include"

          from analytics.INFORMATION_SCHEMA.tables

      ),

      columns as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",

              column_name as "column_name",
              ordinal_position as "column_index",
              data_type as "column_type",
              comment as "column_comment"

          from analytics.INFORMATION_SCHEMA.columns
      )

      select *
      from tables
      join columns using ("table_database", "table_schema", "table_name")
      where (upper("table_schema") = upper('dbt_knguyen_refactor'))
      order by "column_index"
04:25:06.060229 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:25:06.063118 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:25:08.764706 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 2.7 seconds
04:25:08.783126 [debug] [ThreadPool]: On analytics.information_schema: Close
04:25:09.173786 [debug] [ThreadPool]: SQL status: SUCCESS 15 in 3.11 seconds
04:25:09.185371 [debug] [ThreadPool]: On raw.information_schema: Close
04:25:09.359235 [info ] [MainThread]: Catalog written to /workspaces/dbt-fundamentals/dbt-refactoring/target/catalog.json
04:25:09.361392 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4093c59d60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4091e53160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4091cf9d90>]}
04:25:10.312150 [debug] [MainThread]: Connection 'generate_catalog' was properly closed.
04:25:10.313975 [debug] [MainThread]: Connection 'analytics.information_schema' was properly closed.
04:25:10.316224 [debug] [MainThread]: Connection 'raw.information_schema' was properly closed.


============================== 2022-04-20 04:27:35.250054 | 44e6a679-d1b5-41e5-8b09-925cce3fe739 ==============================
04:27:35.250054 [info ] [MainThread]: Running with dbt=1.0.4
04:27:35.253313 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, port=8080, open_browser=True, defer=None, state=None, cls=<class 'dbt.task.serve.ServeTask'>, which='serve', rpc_method=None)
04:27:35.254636 [debug] [MainThread]: Tracking: tracking
04:27:35.257141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4200d901c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4200d90130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f4200d90d60>]}
04:27:35.292991 [info ] [MainThread]: Serving docs at 0.0.0.0:8080
04:27:35.295296 [info ] [MainThread]: To access from your browser, navigate to:  http://localhost:8080
04:27:35.297263 [info ] [MainThread]: 
04:27:35.299701 [info ] [MainThread]: 
04:27:35.302248 [info ] [MainThread]: Press Ctrl+C to exit.


============================== 2022-04-20 04:34:32.930930 | f4fa9c47-58ee-4f7c-87b6-d0801112e299 ==============================
04:34:32.930930 [info ] [MainThread]: Running with dbt=1.0.4
04:34:32.934021 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
04:34:32.936119 [debug] [MainThread]: Tracking: tracking
04:34:32.937985 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdca5b291c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdca5b29130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdca5b29d90>]}
04:34:32.992683 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
04:34:32.994174 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
04:34:33.004524 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f4fa9c47-58ee-4f7c-87b6-d0801112e299', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdca49850d0>]}
04:34:33.020783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f4fa9c47-58ee-4f7c-87b6-d0801112e299', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdca49ceb20>]}
04:34:33.021913 [info ] [MainThread]: Found 1 model, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:34:33.025393 [info ] [MainThread]: 
04:34:33.028036 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:34:33.031219 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
04:34:33.052006 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
04:34:33.053659 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
04:34:33.055184 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:34:33.908714 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.85 seconds
04:34:33.912984 [debug] [ThreadPool]: On list_analytics: Close
04:34:34.051239 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:34:34.063172 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:34:34.064120 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:34:34.065602 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:34:34.755395 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.69 seconds
04:34:34.759635 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:34:34.887421 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:34:34.888922 [info ] [MainThread]: 
04:34:34.897214 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.customer_orders
04:34:34.898428 [info ] [Thread-1  ]: 1 of 1 START view model dbt_knguyen_refactor.customer_orders.................... [RUN]
04:34:34.901288 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.customer_orders"
04:34:34.902831 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.customer_orders
04:34:34.904387 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.customer_orders
04:34:34.913187 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.customer_orders"
04:34:34.917221 [debug] [Thread-1  ]: finished collecting timing info
04:34:34.918256 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.customer_orders
04:34:34.962024 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.customer_orders"
04:34:34.971871 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.customer_orders"
04:34:34.972774 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.customer_orders 
  
   as (
    select 
    orders.id as order_id,
    orders.user_id as customer_id,
    last_name as surname,
    first_name as givenname,
    first_order_date,
    order_count,
    total_lifetime_value,
    round(amount/100.0,2) as order_value_dollars,
    orders.status as order_status,
    payments.status as payment_status
from raw.jaffle_shop.orders as orders

join (
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
) customers
on orders.user_id = customers.id

join (

    select 
        b.id as customer_id,
        b.name as full_name,
        b.last_name as surname,
        b.first_name as givenname,
        min(order_date) as first_order_date,
        min(case when a.status NOT IN ('returned','return_pending') then order_date end) as first_non_returned_order_date,
        max(case when a.status NOT IN ('returned','return_pending') then order_date end) as most_recent_non_returned_order_date,
        COALESCE(max(user_order_seq),0) as order_count,
        COALESCE(count(case when a.status != 'returned' then 1 end),0) as non_returned_order_count,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end) as total_lifetime_value,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end)/NULLIF(count(case when a.status NOT IN ('returned','return_pending') then 1 end),0) as avg_non_returned_order_value,
        array_agg(distinct a.id) as order_ids

    from (
      select 
        row_number() over (partition by user_id order by order_date, id) as user_order_seq,
        *
      from raw.jaffle_shop.orders
    ) a

    join ( 
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
    ) b
    on a.user_id = b.id

    left outer join raw.stripe.payment c
    on a.id = c.orderid

    where a.status NOT IN ('pending') and c.status != 'fail'

    group by b.id, b.name, b.last_name, b.first_name

) customer_order_history
on orders.user_id = customer_order_history.customer_id

left outer join raw.stripe.payment payments
on orders.id = payments.orderid

where payments.status != 'fail'
  );
04:34:34.974282 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
04:34:35.596540 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 0.62 seconds
04:34:35.608696 [debug] [Thread-1  ]: finished collecting timing info
04:34:35.609751 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: Close
04:34:35.762347 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f4fa9c47-58ee-4f7c-87b6-d0801112e299', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc9fb2ad60>]}
04:34:35.765041 [info ] [Thread-1  ]: 1 of 1 OK created view model dbt_knguyen_refactor.customer_orders............... [[32mSUCCESS 1[0m in 0.86s]
04:34:35.766461 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.customer_orders
04:34:35.770058 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:34:35.771219 [info ] [MainThread]: 
04:34:35.773532 [info ] [MainThread]: Finished running 1 view model in 2.74s.
04:34:35.775324 [debug] [MainThread]: Connection 'master' was properly closed.
04:34:35.776481 [debug] [MainThread]: Connection 'list_analytics' was properly closed.
04:34:35.780395 [debug] [MainThread]: Connection 'model.dbt_refactoring.customer_orders' was properly closed.
04:34:35.800254 [info ] [MainThread]: 
04:34:35.802724 [info ] [MainThread]: [32mCompleted successfully[0m
04:34:35.804733 [info ] [MainThread]: 
04:34:35.806160 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
04:34:35.809457 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdca49ae8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc9fabd7f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdc9fa65220>]}


============================== 2022-04-20 04:34:50.583286 | 0339278e-bc50-45e7-9cd5-43f16bfa84ac ==============================
04:34:50.583286 [info ] [MainThread]: Running with dbt=1.0.4
04:34:50.584617 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, compile=True, threads=None, select=None, exclude=None, selector_name=None, state=None, defer=None, cls=<class 'dbt.task.generate.GenerateTask'>, which='generate', rpc_method='docs.generate')
04:34:50.585497 [debug] [MainThread]: Tracking: tracking
04:34:50.587300 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0c4861c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0c486130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0c486d90>]}
04:34:50.637016 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
04:34:50.638115 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
04:34:50.646861 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0339278e-bc50-45e7-9cd5-43f16bfa84ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0b3050d0>]}
04:34:50.660947 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0339278e-bc50-45e7-9cd5-43f16bfa84ac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0b34dc10>]}
04:34:50.661921 [info ] [MainThread]: Found 1 model, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:34:50.666240 [info ] [MainThread]: 
04:34:50.672758 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:34:50.688825 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:34:50.747255 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:34:50.754932 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:34:50.757667 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:34:51.710785 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 0.95 seconds
04:34:51.715310 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:34:51.858877 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:34:51.860618 [info ] [MainThread]: 
04:34:51.869467 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.customer_orders
04:34:51.871100 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.customer_orders"
04:34:51.873133 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.customer_orders
04:34:51.875457 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.customer_orders
04:34:51.885352 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.customer_orders"
04:34:51.890369 [debug] [Thread-1  ]: finished collecting timing info
04:34:51.892150 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.customer_orders
04:34:51.894352 [debug] [Thread-1  ]: finished collecting timing info
04:34:51.897304 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.customer_orders
04:34:51.899893 [debug] [MainThread]: Connection 'master' was properly closed.
04:34:51.900745 [debug] [MainThread]: Connection 'model.dbt_refactoring.customer_orders' was properly closed.
04:34:51.915941 [info ] [MainThread]: Done.
04:34:51.940454 [debug] [MainThread]: Acquiring new snowflake connection "generate_catalog"
04:34:51.942095 [info ] [MainThread]: Building catalog
04:34:51.945540 [debug] [ThreadPool]: Acquiring new snowflake connection "analytics.information_schema"
04:34:51.946553 [debug] [ThreadPool]: Acquiring new snowflake connection "raw.information_schema"
04:34:51.959295 [debug] [ThreadPool]: Using snowflake connection "analytics.information_schema"
04:34:51.965755 [debug] [ThreadPool]: Using snowflake connection "raw.information_schema"
04:34:51.966535 [debug] [ThreadPool]: On analytics.information_schema: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "analytics.information_schema"} */

    
      with tables as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",
              table_type as "table_type",
              comment as "table_comment",

              -- note: this is the _role_ that owns the table
              table_owner as "table_owner",

              'Clustering Key' as "stats:clustering_key:label",
              clustering_key as "stats:clustering_key:value",
              'The key used to cluster this table' as "stats:clustering_key:description",
              (clustering_key is not null) as "stats:clustering_key:include",

              'Row Count' as "stats:row_count:label",
              row_count as "stats:row_count:value",
              'An approximate count of rows in this table' as "stats:row_count:description",
              (row_count is not null) as "stats:row_count:include",

              'Approximate Size' as "stats:bytes:label",
              bytes as "stats:bytes:value",
              'Approximate size of the table as reported by Snowflake' as "stats:bytes:description",
              (bytes is not null) as "stats:bytes:include",

              'Last Modified' as "stats:last_modified:label",
              to_varchar(convert_timezone('UTC', last_altered), 'yyyy-mm-dd HH24:MI'||'UTC') as "stats:last_modified:value",
              'The timestamp for last update/change' as "stats:last_modified:description",
              (last_altered is not null and table_type='BASE TABLE') as "stats:last_modified:include"

          from analytics.INFORMATION_SCHEMA.tables

      ),

      columns as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",

              column_name as "column_name",
              ordinal_position as "column_index",
              data_type as "column_type",
              comment as "column_comment"

          from analytics.INFORMATION_SCHEMA.columns
      )

      select *
      from tables
      join columns using ("table_database", "table_schema", "table_name")
      where (upper("table_schema") = upper('dbt_knguyen_refactor'))
      order by "column_index"
04:34:51.969563 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:34:51.968483 [debug] [ThreadPool]: On raw.information_schema: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "raw.information_schema"} */

    
      with tables as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",
              table_type as "table_type",
              comment as "table_comment",

              -- note: this is the _role_ that owns the table
              table_owner as "table_owner",

              'Clustering Key' as "stats:clustering_key:label",
              clustering_key as "stats:clustering_key:value",
              'The key used to cluster this table' as "stats:clustering_key:description",
              (clustering_key is not null) as "stats:clustering_key:include",

              'Row Count' as "stats:row_count:label",
              row_count as "stats:row_count:value",
              'An approximate count of rows in this table' as "stats:row_count:description",
              (row_count is not null) as "stats:row_count:include",

              'Approximate Size' as "stats:bytes:label",
              bytes as "stats:bytes:value",
              'Approximate size of the table as reported by Snowflake' as "stats:bytes:description",
              (bytes is not null) as "stats:bytes:include",

              'Last Modified' as "stats:last_modified:label",
              to_varchar(convert_timezone('UTC', last_altered), 'yyyy-mm-dd HH24:MI'||'UTC') as "stats:last_modified:value",
              'The timestamp for last update/change' as "stats:last_modified:description",
              (last_altered is not null and table_type='BASE TABLE') as "stats:last_modified:include"

          from raw.INFORMATION_SCHEMA.tables

      ),

      columns as (

          select
              table_catalog as "table_database",
              table_schema as "table_schema",
              table_name as "table_name",

              column_name as "column_name",
              ordinal_position as "column_index",
              data_type as "column_type",
              comment as "column_comment"

          from raw.INFORMATION_SCHEMA.columns
      )

      select *
      from tables
      join columns using ("table_database", "table_schema", "table_name")
      where (upper("table_schema") = upper('jaffle_shop') or upper("table_schema") = upper('stripe'))
      order by "column_index"
04:34:51.976755 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:34:54.191652 [debug] [ThreadPool]: SQL status: SUCCESS 15 in 2.21 seconds
04:34:54.207776 [debug] [ThreadPool]: On raw.information_schema: Close
04:34:54.306685 [debug] [ThreadPool]: SQL status: SUCCESS 10 in 2.34 seconds
04:34:54.317126 [debug] [ThreadPool]: On analytics.information_schema: Close
04:34:54.494257 [info ] [MainThread]: Catalog written to /workspaces/dbt-fundamentals/dbt-refactoring/target/catalog.json
04:34:54.496462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0c4861c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0a493250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8a0a4d9ca0>]}
04:34:55.330412 [debug] [MainThread]: Connection 'generate_catalog' was properly closed.
04:34:55.332835 [debug] [MainThread]: Connection 'analytics.information_schema' was properly closed.
04:34:55.334753 [debug] [MainThread]: Connection 'raw.information_schema' was properly closed.


============================== 2022-04-20 04:35:15.368392 | 753a4a8f-7341-43f0-853a-8fb65902b136 ==============================
04:35:15.368392 [info ] [MainThread]: Running with dbt=1.0.4
04:35:15.370429 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, port=8080, open_browser=True, defer=None, state=None, cls=<class 'dbt.task.serve.ServeTask'>, which='serve', rpc_method=None)
04:35:15.371422 [debug] [MainThread]: Tracking: tracking
04:35:15.373670 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6aacf3d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6aacf3970>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe6aacf3cd0>]}
04:35:15.403747 [info ] [MainThread]: Serving docs at 0.0.0.0:8080
04:35:15.407030 [info ] [MainThread]: To access from your browser, navigate to:  http://localhost:8080
04:35:15.409266 [info ] [MainThread]: 
04:35:15.410750 [info ] [MainThread]: 
04:35:15.413486 [info ] [MainThread]: Press Ctrl+C to exit.


============================== 2022-04-21 01:57:06.766383 | d6cda8d5-fe5c-4c51-9ac1-580e5e0d7ba6 ==============================
01:57:06.766383 [info ] [MainThread]: Running with dbt=1.0.4
01:57:06.767921 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders.sql'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
01:57:06.769136 [debug] [MainThread]: Tracking: tracking
01:57:06.771420 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1550025190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1550025d60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1550025d00>]}
01:57:06.835332 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 4 files added, 0 files changed.
01:57:06.836463 [debug] [MainThread]: Partial parsing: added file: dbt_refactoring://models/staging/stripe/stg_stripe__payments.sql
01:57:06.837686 [debug] [MainThread]: Partial parsing: added file: dbt_refactoring://models/staging/jaffle_shop/stg_jaffle_shop__orders.sql
01:57:06.838875 [debug] [MainThread]: Partial parsing: added file: dbt_refactoring://models/marts/fct_customer_orders.sql
01:57:06.840027 [debug] [MainThread]: Partial parsing: added file: dbt_refactoring://models/staging/jaffle_shop/stg_jaffle_shop__customers.sql
01:57:06.857611 [debug] [MainThread]: 1699: static parser successfully parsed staging/stripe/stg_stripe__payments.sql
01:57:06.875017 [debug] [MainThread]: 1699: static parser successfully parsed staging/jaffle_shop/stg_jaffle_shop__orders.sql
01:57:06.880370 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
01:57:06.887209 [debug] [MainThread]: 1699: static parser successfully parsed staging/jaffle_shop/stg_jaffle_shop__customers.sql
01:57:06.905439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd6cda8d5-fe5c-4c51-9ac1-580e5e0d7ba6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f154e6890d0>]}
01:57:06.923368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd6cda8d5-fe5c-4c51-9ac1-580e5e0d7ba6', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f154efa5e20>]}
01:57:06.924416 [info ] [MainThread]: Found 5 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
01:57:06.926521 [warn ] [MainThread]: The selection criterion '+fct_customer_orders.sql' does not match any nodes
01:57:06.928390 [info ] [MainThread]: 
01:57:06.929564 [warn ] [MainThread]: [[33mWARNING[0m]: Nothing to do. Try checking your model configs and model specification args
01:57:06.948080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f154ef08be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f154ef08c10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f154efa51c0>]}


============================== 2022-04-21 01:57:21.873052 | a70867da-743d-4554-9543-376197305737 ==============================
01:57:21.873052 [info ] [MainThread]: Running with dbt=1.0.4
01:57:21.874689 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
01:57:21.876390 [debug] [MainThread]: Tracking: tracking
01:57:21.878470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f10627311c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1062731130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1062731d90>]}
01:57:21.936384 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
01:57:21.937308 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
01:57:21.946745 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a70867da-743d-4554-9543-376197305737', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f106158e0d0>]}
01:57:21.961259 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a70867da-743d-4554-9543-376197305737', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f10626896a0>]}
01:57:21.962590 [info ] [MainThread]: Found 5 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
01:57:21.966932 [info ] [MainThread]: 
01:57:21.969040 [debug] [MainThread]: Acquiring new snowflake connection "master"
01:57:21.971900 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
01:57:21.995815 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
01:57:21.997795 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
01:57:22.000133 [debug] [ThreadPool]: Opening a new connection, currently in state init
01:57:23.982028 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 1.98 seconds
01:57:23.986429 [debug] [ThreadPool]: On list_analytics: Close
01:57:24.132968 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
01:57:24.144364 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
01:57:24.145310 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
01:57:24.146701 [debug] [ThreadPool]: Opening a new connection, currently in state closed
01:57:25.210239 [debug] [ThreadPool]: SQL status: SUCCESS 1 in 1.06 seconds
01:57:25.214060 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
01:57:25.364249 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
01:57:25.365954 [info ] [MainThread]: 
01:57:25.375589 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:25.376506 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:25.377197 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_stripe__payments
01:57:25.377781 [info ] [Thread-2  ]: 2 of 4 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
01:57:25.379297 [info ] [Thread-1  ]: 1 of 4 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
01:57:25.380474 [info ] [Thread-3  ]: 3 of 4 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
01:57:25.383156 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:25.384890 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:25.386928 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
01:57:25.388474 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:25.389955 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:25.391882 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
01:57:25.393364 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
01:57:25.394569 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
01:57:25.396074 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_stripe__payments
01:57:25.409247 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:25.412519 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:25.418538 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
01:57:25.434434 [debug] [Thread-1  ]: finished collecting timing info
01:57:25.436582 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:25.437352 [debug] [Thread-2  ]: finished collecting timing info
01:57:25.459846 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:25.466046 [debug] [Thread-3  ]: finished collecting timing info
01:57:25.492799 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:25.494373 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:25.494659 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
01:57:25.502889 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
01:57:25.510987 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:25.512626 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
01:57:25.514374 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:25.515585 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
01:57:25.517049 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
01:57:25.517915 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
01:57:25.524898 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
01:57:25.529338 [debug] [Thread-2  ]: Opening a new connection, currently in state init
01:57:25.530657 [debug] [Thread-3  ]: Opening a new connection, currently in state init
01:57:26.526059 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.01 seconds
01:57:26.540729 [debug] [Thread-1  ]: finished collecting timing info
01:57:26.541853 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
01:57:26.638093 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.11 seconds
01:57:26.642192 [debug] [Thread-3  ]: finished collecting timing info
01:57:26.643500 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: Close
01:57:26.655954 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 1.13 seconds
01:57:26.659342 [debug] [Thread-2  ]: finished collecting timing info
01:57:26.660254 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
01:57:26.677884 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a70867da-743d-4554-9543-376197305737', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1060610880>]}
01:57:26.680242 [info ] [Thread-1  ]: 1 of 4 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.29s]
01:57:26.682831 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:26.798247 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a70867da-743d-4554-9543-376197305737', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1060610c40>]}
01:57:26.800417 [info ] [Thread-3  ]: 3 of 4 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.41s]
01:57:26.801957 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a70867da-743d-4554-9543-376197305737', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f10605338b0>]}
01:57:26.804859 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
01:57:26.806651 [info ] [Thread-2  ]: 2 of 4 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.42s]
01:57:26.810362 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:26.813856 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.fct_customer_orders
01:57:26.814996 [info ] [Thread-4  ]: 4 of 4 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
01:57:26.818548 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
01:57:26.820060 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
01:57:26.823502 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.fct_customer_orders
01:57:26.830073 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
01:57:26.842816 [debug] [Thread-4  ]: finished collecting timing info
01:57:26.843953 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.fct_customer_orders
01:57:26.849694 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
01:57:26.863193 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
01:57:26.864289 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
),
customer_order_history as (
    select 
        customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname,
        min(order_date) as first_order_date,

        min(case 
                when orders.order_status not in ('returned','return_pending') 
                    then order_date 
            end) as first_non_returned_order_date,
        
        max(case 
                when orders.order_status not in ('returned','return_pending') 
                    then order_date 
            end) as most_recent_non_returned_order_date,
        
        COALESCE(max(user_order_seq),0) as order_count,

        COALESCE(
            count(case 
                    when orders.order_status != 'returned' 
                        then 1 
                end)
            ,0) as non_returned_order_count,

        sum(case 
                when orders.order_status not in ('returned','return_pending') 
                    then payments.payment_amount 
                else 0 
            end) as total_lifetime_value,

        sum(case 
                when orders.order_status not in ('returned','return_pending') 
                    then payments.payment_amount 
                else 0 
            end) / NULLIF(
                        count(case 
                                when orders.order_status not in ('returned','return_pending') 
                                    then 1 
                              end)
                        ,0) as avg_non_returned_order_value,

        array_agg(distinct orders.order_id) as order_ids

    from orders

    join customers
    on orders.customer_id = customers.customer_id

    left outer join payments
    on orders.order_id = payments.order_id

    where orders.order_status not in ('pending') and payments.payment_status != 'fail'

    group by customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname

),
-- Final CTE
final as (
    select 
        orders.order_id,
        orders.customer_id,
        customers.surname,
        customers.givenname,
        first_order_date,
        order_count,
        total_lifetime_value,
        payment.payment_amount as order_value_dollars,
        orders.order_status,
        payments.payment_status
    from orders

    join customers
    on orders.customer_id = customers.id

    join customer_order_history
    on orders.customer_id = customer_order_history.customer_id

    left outer join payments
    on orders.order_id = payments.order_id

    where payments.payment_status != 'fail'
)
-- Simple Select statement
select * from final
  );
01:57:26.866834 [debug] [Thread-4  ]: Opening a new connection, currently in state init
01:57:27.600559 [debug] [Thread-4  ]: Snowflake adapter: Snowflake query id: 01a3bed5-0000-5727-0000-469d0001e00e
01:57:27.602280 [debug] [Thread-4  ]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 88 at position 8
invalid identifier 'PAYMENT.PAYMENT_AMOUNT'
01:57:27.604731 [debug] [Thread-4  ]: finished collecting timing info
01:57:27.606648 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: Close
01:57:27.748613 [debug] [Thread-4  ]: Database Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)
  000904 (42000): SQL compilation error: error line 88 at position 8
  invalid identifier 'PAYMENT.PAYMENT_AMOUNT'
  compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
01:57:27.750309 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a70867da-743d-4554-9543-376197305737', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1060054910>]}
01:57:27.753054 [error] [Thread-4  ]: 4 of 4 ERROR creating view model dbt_knguyen_refactor.fct_customer_orders....... [[31mERROR[0m in 0.93s]
01:57:27.754650 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.fct_customer_orders
01:57:27.758962 [debug] [MainThread]: Acquiring new snowflake connection "master"
01:57:27.760869 [info ] [MainThread]: 
01:57:27.762719 [info ] [MainThread]: Finished running 4 view models in 5.79s.
01:57:27.764575 [debug] [MainThread]: Connection 'master' was properly closed.
01:57:27.765553 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
01:57:27.768199 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__orders' was properly closed.
01:57:27.770287 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_stripe__payments' was properly closed.
01:57:27.772131 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
01:57:27.788914 [info ] [MainThread]: 
01:57:27.790529 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
01:57:27.791498 [info ] [MainThread]: 
01:57:27.793810 [error] [MainThread]: [33mDatabase Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)[0m
01:57:27.795795 [error] [MainThread]:   000904 (42000): SQL compilation error: error line 88 at position 8
01:57:27.799233 [error] [MainThread]:   invalid identifier 'PAYMENT.PAYMENT_AMOUNT'
01:57:27.800848 [error] [MainThread]:   compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
01:57:27.806003 [info ] [MainThread]: 
01:57:27.807443 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
01:57:27.811017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f106005bb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f106005bac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f106001c8b0>]}


============================== 2022-04-21 01:57:54.119778 | cfa8cd14-cfac-43e6-a0f5-97d3bad52c7a ==============================
01:57:54.119778 [info ] [MainThread]: Running with dbt=1.0.4
01:57:54.121633 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
01:57:54.122601 [debug] [MainThread]: Tracking: tracking
01:57:54.124289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78fc85190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78fc85100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78fc85040>]}
01:57:54.184193 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
01:57:54.186535 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/marts/fct_customer_orders.sql
01:57:54.205312 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
01:57:54.237784 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cfa8cd14-cfac-43e6-a0f5-97d3bad52c7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78e2d10d0>]}
01:57:54.253100 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cfa8cd14-cfac-43e6-a0f5-97d3bad52c7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78eb5baf0>]}
01:57:54.254447 [info ] [MainThread]: Found 5 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
01:57:54.257531 [info ] [MainThread]: 
01:57:54.259598 [debug] [MainThread]: Acquiring new snowflake connection "master"
01:57:54.262688 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
01:57:54.283396 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
01:57:54.285362 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
01:57:54.287076 [debug] [ThreadPool]: Opening a new connection, currently in state init
01:57:55.170881 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.88 seconds
01:57:55.175370 [debug] [ThreadPool]: On list_analytics: Close
01:57:55.311159 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
01:57:55.322923 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
01:57:55.323819 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
01:57:55.325321 [debug] [ThreadPool]: Opening a new connection, currently in state init
01:57:56.069609 [debug] [ThreadPool]: SQL status: SUCCESS 4 in 0.74 seconds
01:57:56.072997 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
01:57:56.227741 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
01:57:56.229547 [info ] [MainThread]: 
01:57:56.238288 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:56.238638 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:56.239029 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_stripe__payments
01:57:56.241639 [info ] [Thread-1  ]: 1 of 4 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
01:57:56.242860 [info ] [Thread-2  ]: 2 of 4 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
01:57:56.244002 [info ] [Thread-3  ]: 3 of 4 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
01:57:56.245973 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:56.248543 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:56.253945 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:56.251629 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:56.250440 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
01:57:56.255582 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
01:57:56.257358 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
01:57:56.258778 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
01:57:56.271553 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_stripe__payments
01:57:56.270164 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:56.264799 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:56.275897 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
01:57:56.281198 [debug] [Thread-1  ]: finished collecting timing info
01:57:56.285353 [debug] [Thread-2  ]: finished collecting timing info
01:57:56.286242 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:56.287766 [debug] [Thread-3  ]: finished collecting timing info
01:57:56.288716 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:56.302416 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
01:57:56.336117 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:56.341012 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:56.345792 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
01:57:56.351729 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
01:57:56.353192 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
01:57:56.356503 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
01:57:56.359304 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
01:57:56.361176 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
01:57:56.362221 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
01:57:56.368269 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
01:57:56.370531 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
01:57:56.371732 [debug] [Thread-3  ]: Opening a new connection, currently in state init
01:57:57.426357 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.07 seconds
01:57:57.439473 [debug] [Thread-1  ]: finished collecting timing info
01:57:57.441113 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 1.07 seconds
01:57:57.442372 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
01:57:57.449524 [debug] [Thread-2  ]: finished collecting timing info
01:57:57.454938 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
01:57:57.489287 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.12 seconds
01:57:57.493772 [debug] [Thread-3  ]: finished collecting timing info
01:57:57.496709 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: Close
01:57:57.587910 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfa8cd14-cfac-43e6-a0f5-97d3bad52c7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78c6d92b0>]}
01:57:57.589767 [info ] [Thread-1  ]: 1 of 4 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.34s]
01:57:57.591131 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
01:57:57.604161 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfa8cd14-cfac-43e6-a0f5-97d3bad52c7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78c6a4c40>]}
01:57:57.605542 [info ] [Thread-2  ]: 2 of 4 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.36s]
01:57:57.607092 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
01:57:57.636640 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfa8cd14-cfac-43e6-a0f5-97d3bad52c7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78c70fe20>]}
01:57:57.639983 [info ] [Thread-3  ]: 3 of 4 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.39s]
01:57:57.643023 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
01:57:57.644545 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.fct_customer_orders
01:57:57.645695 [info ] [Thread-4  ]: 4 of 4 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
01:57:57.648209 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
01:57:57.649126 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
01:57:57.653965 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.fct_customer_orders
01:57:57.672108 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
01:57:57.677138 [debug] [Thread-4  ]: finished collecting timing info
01:57:57.678120 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.fct_customer_orders
01:57:57.684746 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
01:57:57.693425 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
01:57:57.694196 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
),
customer_order_history as (
    select 
        customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname,
        min(order_date) as first_order_date,

        min(case 
                when orders.order_status not in ('returned','return_pending') 
                    then order_date 
            end) as first_non_returned_order_date,
        
        max(case 
                when orders.order_status not in ('returned','return_pending') 
                    then order_date 
            end) as most_recent_non_returned_order_date,
        
        COALESCE(max(user_order_seq),0) as order_count,

        COALESCE(
            count(case 
                    when orders.order_status != 'returned' 
                        then 1 
                end)
            ,0) as non_returned_order_count,

        sum(case 
                when orders.order_status not in ('returned','return_pending') 
                    then payments.payment_amount 
                else 0 
            end) as total_lifetime_value,

        sum(case 
                when orders.order_status not in ('returned','return_pending') 
                    then payments.payment_amount 
                else 0 
            end) / NULLIF(
                        count(case 
                                when orders.order_status not in ('returned','return_pending') 
                                    then 1 
                              end)
                        ,0) as avg_non_returned_order_value,

        array_agg(distinct orders.order_id) as order_ids

    from orders

    join customers
    on orders.customer_id = customers.customer_id

    left outer join payments
    on orders.order_id = payments.order_id

    where orders.order_status not in ('pending') and payments.payment_status != 'fail'

    group by customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname

),
-- Final CTE
final as (
    select 
        orders.order_id,
        orders.customer_id,
        customers.surname,
        customers.givenname,
        first_order_date,
        order_count,
        total_lifetime_value,
        payments.payment_amount as order_value_dollars,
        orders.order_status,
        payments.payment_status
    from orders

    join customers
    on orders.customer_id = customers.id

    join customer_order_history
    on orders.customer_id = customer_order_history.customer_id

    left outer join payments
    on orders.order_id = payments.order_id

    where payments.payment_status != 'fail'
)
-- Simple Select statement
select * from final
  );
01:57:57.695529 [debug] [Thread-4  ]: Opening a new connection, currently in state init
01:57:58.493060 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 0.8 seconds
01:57:58.499344 [debug] [Thread-4  ]: finished collecting timing info
01:57:58.501164 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: Close
01:57:58.672012 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cfa8cd14-cfac-43e6-a0f5-97d3bad52c7a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78c6a4fa0>]}
01:57:58.676289 [info ] [Thread-4  ]: 4 of 4 OK created view model dbt_knguyen_refactor.fct_customer_orders........... [[32mSUCCESS 1[0m in 1.02s]
01:57:58.677846 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.fct_customer_orders
01:57:58.682308 [debug] [MainThread]: Acquiring new snowflake connection "master"
01:57:58.684497 [info ] [MainThread]: 
01:57:58.686123 [info ] [MainThread]: Finished running 4 view models in 4.43s.
01:57:58.687677 [debug] [MainThread]: Connection 'master' was properly closed.
01:57:58.688993 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__orders' was properly closed.
01:57:58.691470 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
01:57:58.693071 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_stripe__payments' was properly closed.
01:57:58.694919 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
01:57:58.714687 [info ] [MainThread]: 
01:57:58.716959 [info ] [MainThread]: [32mCompleted successfully[0m
01:57:58.719080 [info ] [MainThread]: 
01:57:58.723708 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
01:57:58.726059 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78c6f9ca0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78c6f9580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa78d4aa7f0>]}


============================== 2022-04-21 03:19:46.964487 | dde20f80-eeaa-457e-b35c-c74df6e4521c ==============================
03:19:46.964487 [info ] [MainThread]: Running with dbt=1.0.4
03:19:46.968333 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
03:19:46.970387 [debug] [MainThread]: Tracking: tracking
03:19:46.972229 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f12516a11c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f12516a1130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f12516a1d90>]}
03:19:47.039784 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 2 files changed.
03:19:47.041080 [debug] [MainThread]: Partial parsing: added file: dbt_refactoring://models/marts/intermediate/int_orders.sql
03:19:47.042581 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/marts/fct_customer_orders.sql
03:19:47.043991 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/staging/jaffle_shop/stg_jaffle_shop__orders.sql
03:19:47.061234 [debug] [MainThread]: 1699: static parser successfully parsed marts/intermediate/int_orders.sql
03:19:47.082211 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
03:19:47.086674 [debug] [MainThread]: 1699: static parser successfully parsed staging/jaffle_shop/stg_jaffle_shop__orders.sql
03:19:47.106655 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dde20f80-eeaa-457e-b35c-c74df6e4521c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f12500d50d0>]}
03:19:47.124805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dde20f80-eeaa-457e-b35c-c74df6e4521c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f12505e0790>]}
03:19:47.125993 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
03:19:47.131238 [info ] [MainThread]: 
03:19:47.133428 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:19:47.136552 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
03:19:47.157447 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
03:19:47.159621 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
03:19:47.161902 [debug] [ThreadPool]: Opening a new connection, currently in state init
03:19:48.046756 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.88 seconds
03:19:48.050812 [debug] [ThreadPool]: On list_analytics: Close
03:19:48.196320 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
03:19:48.207487 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
03:19:48.208434 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
03:19:48.210090 [debug] [ThreadPool]: Opening a new connection, currently in state closed
03:19:48.824901 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 0.61 seconds
03:19:48.828669 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
03:19:49.005136 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
03:19:49.007282 [info ] [MainThread]: 
03:19:49.019835 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
03:19:49.020669 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
03:19:49.022189 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.stg_stripe__payments
03:19:49.024956 [info ] [Thread-4  ]: 3 of 5 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
03:19:49.024120 [info ] [Thread-3  ]: 2 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
03:19:49.022569 [info ] [Thread-1  ]: 1 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
03:19:49.027313 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
03:19:49.032412 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
03:19:49.032090 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
03:19:49.037639 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
03:19:49.035726 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.stg_stripe__payments
03:19:49.029708 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
03:19:49.039793 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
03:19:49.046869 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
03:19:49.047547 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
03:19:49.052973 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
03:19:49.060231 [debug] [Thread-4  ]: finished collecting timing info
03:19:49.057945 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
03:19:49.062221 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
03:19:49.071045 [debug] [Thread-1  ]: finished collecting timing info
03:19:49.073023 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
03:19:49.084651 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
03:19:49.115183 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
03:19:49.115570 [debug] [Thread-3  ]: finished collecting timing info
03:19:49.120361 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
03:19:49.123430 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
03:19:49.126537 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
03:19:49.132095 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
03:19:49.132994 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
03:19:49.135686 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
03:19:49.139541 [debug] [Thread-4  ]: Opening a new connection, currently in state init
03:19:49.140593 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
03:19:49.146845 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
03:19:49.148098 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
03:19:49.149148 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        case 
            when orders.order_status not in ('returned','return_pending') 
                then order_date 
        end as valid_order_date,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
03:19:49.156595 [debug] [Thread-3  ]: Opening a new connection, currently in state init
03:19:50.293793 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 1.15 seconds
03:19:50.308556 [debug] [Thread-4  ]: finished collecting timing info
03:19:50.310067 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: Close
03:19:50.391412 [debug] [Thread-3  ]: Snowflake adapter: Snowflake query id: 01a3bf27-0000-5727-0000-469d0001e01e
03:19:50.393038 [debug] [Thread-3  ]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 15 at position 17
invalid identifier 'ORDERS.ORDER_STATUS'
03:19:50.400809 [debug] [Thread-3  ]: finished collecting timing info
03:19:50.402781 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
03:19:50.458827 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dde20f80-eeaa-457e-b35c-c74df6e4521c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f1248902b80>]}
03:19:50.461959 [info ] [Thread-4  ]: 3 of 5 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.43s]
03:19:50.468044 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
03:19:50.509129 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.36 seconds
03:19:50.513811 [debug] [Thread-1  ]: finished collecting timing info
03:19:50.514906 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
03:19:50.563223 [debug] [Thread-3  ]: Database Error in model stg_jaffle_shop__orders (models/staging/jaffle_shop/stg_jaffle_shop__orders.sql)
  000904 (42000): SQL compilation error: error line 15 at position 17
  invalid identifier 'ORDERS.ORDER_STATUS'
  compiled SQL at target/run/dbt_refactoring/models/staging/jaffle_shop/stg_jaffle_shop__orders.sql
03:19:50.564841 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dde20f80-eeaa-457e-b35c-c74df6e4521c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f12488e7040>]}
03:19:50.566586 [error] [Thread-3  ]: 2 of 5 ERROR creating view model dbt_knguyen_refactor.stg_jaffle_shop__orders... [[31mERROR[0m in 1.54s]
03:19:50.571844 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
03:19:50.573800 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.int_orders
03:19:50.574751 [info ] [Thread-2  ]: 4 of 5 SKIP relation dbt_knguyen_refactor.int_orders............................ [[33mSKIP[0m]
03:19:50.577369 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.int_orders
03:19:50.648781 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'dde20f80-eeaa-457e-b35c-c74df6e4521c', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f124ae134f0>]}
03:19:50.650566 [info ] [Thread-1  ]: 1 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.62s]
03:19:50.651987 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
03:19:50.653895 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.fct_customer_orders
03:19:50.655040 [info ] [Thread-3  ]: 5 of 5 SKIP relation dbt_knguyen_refactor.fct_customer_orders................... [[33mSKIP[0m]
03:19:50.656752 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.fct_customer_orders
03:19:50.660775 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:19:50.662321 [info ] [MainThread]: 
03:19:50.663983 [info ] [MainThread]: Finished running 5 view models in 3.53s.
03:19:50.665563 [debug] [MainThread]: Connection 'master' was properly closed.
03:19:50.667168 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
03:19:50.669551 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_stripe__payments' was properly closed.
03:19:50.671213 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__orders' was properly closed.
03:19:50.686486 [info ] [MainThread]: 
03:19:50.688274 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
03:19:50.692341 [info ] [MainThread]: 
03:19:50.693957 [error] [MainThread]: [33mDatabase Error in model stg_jaffle_shop__orders (models/staging/jaffle_shop/stg_jaffle_shop__orders.sql)[0m
03:19:50.696769 [error] [MainThread]:   000904 (42000): SQL compilation error: error line 15 at position 17
03:19:50.699983 [error] [MainThread]:   invalid identifier 'ORDERS.ORDER_STATUS'
03:19:50.702095 [error] [MainThread]:   compiled SQL at target/run/dbt_refactoring/models/staging/jaffle_shop/stg_jaffle_shop__orders.sql
03:19:50.706045 [info ] [MainThread]: 
03:19:50.709431 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=2 TOTAL=5
03:19:50.713919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f125055ce80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f125055cdf0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f12480c3460>]}


============================== 2022-04-21 03:20:48.263856 | 52923743-e98f-4381-aac3-0f65338c2a97 ==============================
03:20:48.263856 [info ] [MainThread]: Running with dbt=1.0.4
03:20:48.266511 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
03:20:48.268376 [debug] [MainThread]: Tracking: tracking
03:20:48.271163 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f2078be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f2078730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f20785b0>]}
03:20:48.343401 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
03:20:48.345472 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/staging/jaffle_shop/stg_jaffle_shop__orders.sql
03:20:48.363243 [debug] [MainThread]: 1699: static parser successfully parsed staging/jaffle_shop/stg_jaffle_shop__orders.sql
03:20:48.397216 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '52923743-e98f-4381-aac3-0f65338c2a97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f06d00d0>]}
03:20:48.414024 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '52923743-e98f-4381-aac3-0f65338c2a97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f0fc19d0>]}
03:20:48.415422 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
03:20:48.420632 [info ] [MainThread]: 
03:20:48.422501 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:20:48.425834 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
03:20:48.446175 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
03:20:48.447379 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
03:20:48.449453 [debug] [ThreadPool]: Opening a new connection, currently in state init
03:20:49.284663 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.84 seconds
03:20:49.289619 [debug] [ThreadPool]: On list_analytics: Close
03:20:49.436159 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
03:20:49.449254 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
03:20:49.451020 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
03:20:49.452711 [debug] [ThreadPool]: Opening a new connection, currently in state closed
03:20:50.312838 [debug] [ThreadPool]: SQL status: SUCCESS 5 in 0.86 seconds
03:20:50.319161 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
03:20:50.454466 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
03:20:50.456097 [info ] [MainThread]: 
03:20:50.464258 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
03:20:50.465232 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
03:20:50.465935 [info ] [Thread-1  ]: 1 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
03:20:50.466183 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.stg_stripe__payments
03:20:50.468634 [info ] [Thread-3  ]: 2 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
03:20:50.470870 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
03:20:50.471285 [info ] [Thread-4  ]: 3 of 5 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
03:20:50.473844 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
03:20:50.475051 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
03:20:50.477848 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
03:20:50.479836 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
03:20:50.482076 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
03:20:50.483124 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
03:20:50.484945 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
03:20:50.492014 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
03:20:50.494247 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.stg_stripe__payments
03:20:50.500069 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
03:20:50.510988 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
03:20:50.513218 [debug] [Thread-1  ]: finished collecting timing info
03:20:50.516414 [debug] [Thread-3  ]: finished collecting timing info
03:20:50.518114 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
03:20:50.519670 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
03:20:50.520089 [debug] [Thread-4  ]: finished collecting timing info
03:20:50.544443 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
03:20:50.579886 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
03:20:50.580516 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
03:20:50.582394 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
03:20:50.591040 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
03:20:50.592849 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
03:20:50.593252 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
03:20:50.595275 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
03:20:50.595511 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        case 
            when order_status not in ('returned','return_pending') 
                then order_date 
        end as valid_order_date,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
03:20:50.597952 [debug] [Thread-4  ]: Opening a new connection, currently in state init
03:20:50.599104 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
03:20:50.600107 [debug] [Thread-3  ]: Opening a new connection, currently in state init
03:20:50.605785 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
03:20:51.681753 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.08 seconds
03:20:51.691422 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 1.09 seconds
03:20:51.708054 [debug] [Thread-1  ]: finished collecting timing info
03:20:51.709788 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.11 seconds
03:20:51.716401 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
03:20:51.718175 [debug] [Thread-4  ]: finished collecting timing info
03:20:51.721508 [debug] [Thread-3  ]: finished collecting timing info
03:20:51.725563 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: Close
03:20:51.726945 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
03:20:51.866831 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '52923743-e98f-4381-aac3-0f65338c2a97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70db311250>]}
03:20:51.868665 [info ] [Thread-1  ]: 1 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.40s]
03:20:51.871412 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
03:20:51.876867 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '52923743-e98f-4381-aac3-0f65338c2a97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70d82d57f0>]}
03:20:51.879166 [info ] [Thread-3  ]: 2 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.40s]
03:20:51.882057 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '52923743-e98f-4381-aac3-0f65338c2a97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70d828a250>]}
03:20:51.883149 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
03:20:51.886249 [info ] [Thread-4  ]: 3 of 5 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.40s]
03:20:51.892436 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
03:20:51.894768 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.int_orders
03:20:51.896300 [info ] [Thread-2  ]: 4 of 5 START view model dbt_knguyen_refactor.int_orders......................... [RUN]
03:20:51.898801 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.int_orders"
03:20:51.899770 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.int_orders
03:20:51.906352 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.int_orders
03:20:51.919929 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.int_orders"
03:20:51.930337 [debug] [Thread-2  ]: finished collecting timing info
03:20:51.931361 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.int_orders
03:20:51.939739 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.int_orders"
03:20:51.948120 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.int_orders"
03:20:51.948744 [debug] [Thread-2  ]: On model.dbt_refactoring.int_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.int_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.int_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
    where payment_status != 'fail'
),
-----------
order_totals as (
    select
        order_id,
        payment_status,
        sum(payment_amount) as order_value_dollars
    from payments
    group by 1, 2
),
order_value_joined as (
    select
        orders.*,
        order_totals.payment_status,
        order_totals.order_value_dollars
    from orders
    left join order_totals
        on orders.order_id = order_totals.order_id
)
select * from order_value_joined
  );
03:20:51.949935 [debug] [Thread-2  ]: Opening a new connection, currently in state init
03:20:52.663744 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 0.71 seconds
03:20:52.668392 [debug] [Thread-2  ]: finished collecting timing info
03:20:52.669646 [debug] [Thread-2  ]: On model.dbt_refactoring.int_orders: Close
03:20:52.815441 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '52923743-e98f-4381-aac3-0f65338c2a97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70d828a5b0>]}
03:20:52.817450 [info ] [Thread-2  ]: 4 of 5 OK created view model dbt_knguyen_refactor.int_orders.................... [[32mSUCCESS 1[0m in 0.92s]
03:20:52.819693 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.int_orders
03:20:52.822297 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.fct_customer_orders
03:20:52.823906 [info ] [Thread-3  ]: 5 of 5 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
03:20:52.826305 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
03:20:52.828411 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
03:20:52.830080 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.fct_customer_orders
03:20:52.837498 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
03:20:52.842437 [debug] [Thread-3  ]: finished collecting timing info
03:20:52.843980 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.fct_customer_orders
03:20:52.848266 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
03:20:52.858166 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
03:20:52.860233 [debug] [Thread-3  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
orders as (
    select * from analytics.dbt_knguyen_refactor.int_orders
)
-----------

-----------
customer_order_history as (
    select 
        customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname,
        min(orders.order_date) as first_order_date,

        min(orders.valid_order_date) as first_non_returned_order_date,
        
        max(orders.valid_order_date) as most_recent_non_returned_order_date,
        
        COALESCE(max(orders.user_order_seq),0) as order_count,

        COALESCE(
            count(case 
                    when orders.valid_order_date is not null
                        then 1 
                end)
            ,0) as non_returned_order_count,

        sum(case 
                when orders.valid_order_date is not null
                    then orders.order_value_dollars
                else 0 
            end) as total_lifetime_value,

        sum(case 
                when orders.valid_order_date is not null
                    then orders.order_value_dollars
                else 0 
            end) / NULLIF(
                        count(case 
                                when orders.valid_order_date is not null
                                    then 1 
                              end)
                        ,0) as avg_non_returned_order_value,

        array_agg(distinct orders.order_id) as order_ids

    from orders

    join customers
    on orders.customer_id = customers.customer_id

    group by customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname

),
-- Final CTE
final as (
    select 
        orders.order_id,
        orders.customer_id,
        customers.surname,
        customers.givenname,
        first_order_date,
        order_count,
        total_lifetime_value,
        orders.order_value_dollars,
        orders.order_status,
        orders.payment_status
    from orders

    join customers
    on orders.customer_id = customers.id

    join customer_order_history
    on orders.customer_id = customer_order_history.customer_id

)
-- Simple Select statement
select * from final
  );
03:20:52.862640 [debug] [Thread-3  ]: Opening a new connection, currently in state closed
03:20:53.459350 [debug] [Thread-3  ]: Snowflake adapter: Snowflake query id: 01a3bf28-0000-574a-0000-469d0001f036
03:20:53.460967 [debug] [Thread-3  ]: Snowflake adapter: Snowflake error: 001003 (42000): SQL compilation error:
syntax error line 16 at position 0 unexpected 'customer_order_history'.
syntax error line 22 at position 31 unexpected 'as'.
03:20:53.463102 [debug] [Thread-3  ]: finished collecting timing info
03:20:53.464815 [debug] [Thread-3  ]: On model.dbt_refactoring.fct_customer_orders: Close
03:20:53.626135 [debug] [Thread-3  ]: Database Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)
  001003 (42000): SQL compilation error:
  syntax error line 16 at position 0 unexpected 'customer_order_history'.
  syntax error line 22 at position 31 unexpected 'as'.
  compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
03:20:53.627929 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '52923743-e98f-4381-aac3-0f65338c2a97', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70db308be0>]}
03:20:53.630331 [error] [Thread-3  ]: 5 of 5 ERROR creating view model dbt_knguyen_refactor.fct_customer_orders....... [[31mERROR[0m in 0.80s]
03:20:53.632294 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.fct_customer_orders
03:20:53.636980 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:20:53.639030 [info ] [MainThread]: 
03:20:53.640265 [info ] [MainThread]: Finished running 5 view models in 5.22s.
03:20:53.642691 [debug] [MainThread]: Connection 'master' was properly closed.
03:20:53.644746 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
03:20:53.646831 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
03:20:53.648693 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_stripe__payments' was properly closed.
03:20:53.650370 [debug] [MainThread]: Connection 'model.dbt_refactoring.int_orders' was properly closed.
03:20:53.669759 [info ] [MainThread]: 
03:20:53.671528 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
03:20:53.673342 [info ] [MainThread]: 
03:20:53.676742 [error] [MainThread]: [33mDatabase Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)[0m
03:20:53.679249 [error] [MainThread]:   001003 (42000): SQL compilation error:
03:20:53.680975 [error] [MainThread]:   syntax error line 16 at position 0 unexpected 'customer_order_history'.
03:20:53.682764 [error] [MainThread]:   syntax error line 22 at position 31 unexpected 'as'.
03:20:53.685830 [error] [MainThread]:   compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
03:20:53.689919 [info ] [MainThread]: 
03:20:53.692713 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
03:20:53.698439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f004d760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f004d9d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f70f0043430>]}


============================== 2022-04-21 03:21:16.689032 | afc51979-efe3-4070-81e9-94942109e560 ==============================
03:21:16.689032 [info ] [MainThread]: Running with dbt=1.0.4
03:21:16.690681 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
03:21:16.691816 [debug] [MainThread]: Tracking: tracking
03:21:16.694267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f30711c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f3071130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f3071d90>]}
03:21:16.752087 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
03:21:16.753525 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/marts/fct_customer_orders.sql
03:21:16.771108 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
03:21:16.804070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'afc51979-efe3-4070-81e9-94942109e560', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f16910d0>]}
03:21:16.820097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'afc51979-efe3-4070-81e9-94942109e560', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f1f819d0>]}
03:21:16.821615 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
03:21:16.827494 [info ] [MainThread]: 
03:21:16.829463 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:21:16.833613 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
03:21:16.854799 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
03:21:16.855991 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
03:21:16.857947 [debug] [ThreadPool]: Opening a new connection, currently in state init
03:21:17.687264 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.83 seconds
03:21:17.691757 [debug] [ThreadPool]: On list_analytics: Close
03:21:17.841505 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
03:21:17.852777 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
03:21:17.853565 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
03:21:17.854739 [debug] [ThreadPool]: Opening a new connection, currently in state closed
03:21:18.443112 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.59 seconds
03:21:18.449397 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
03:21:18.586786 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
03:21:18.588690 [info ] [MainThread]: 
03:21:18.597574 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
03:21:18.598366 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
03:21:18.598978 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.stg_stripe__payments
03:21:18.600046 [info ] [Thread-1  ]: 1 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
03:21:18.601477 [info ] [Thread-3  ]: 2 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
03:21:18.602931 [info ] [Thread-4  ]: 3 of 5 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
03:21:18.606327 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
03:21:18.608719 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
03:21:18.610068 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
03:21:18.611319 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
03:21:18.613053 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
03:21:18.614292 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
03:21:18.615479 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
03:21:18.616816 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
03:21:18.618526 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.stg_stripe__payments
03:21:18.624008 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
03:21:18.629581 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
03:21:18.633932 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
03:21:18.639595 [debug] [Thread-1  ]: finished collecting timing info
03:21:18.641624 [debug] [Thread-3  ]: finished collecting timing info
03:21:18.646077 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
03:21:18.649414 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
03:21:18.650155 [debug] [Thread-4  ]: finished collecting timing info
03:21:18.714879 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
03:21:18.720954 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
03:21:18.722498 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
03:21:18.730599 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
03:21:18.735148 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
03:21:18.736334 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        case 
            when order_status not in ('returned','return_pending') 
                then order_date 
        end as valid_order_date,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
03:21:18.738159 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
03:21:18.740912 [debug] [Thread-3  ]: Opening a new connection, currently in state init
03:21:18.741773 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
03:21:18.743493 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
03:21:18.748264 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
03:21:18.749677 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
03:21:18.755559 [debug] [Thread-4  ]: Opening a new connection, currently in state init
03:21:19.881391 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.13 seconds
03:21:19.893273 [debug] [Thread-1  ]: finished collecting timing info
03:21:19.894094 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
03:21:19.974818 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 1.22 seconds
03:21:19.977905 [debug] [Thread-4  ]: finished collecting timing info
03:21:19.981181 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: Close
03:21:20.037088 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'afc51979-efe3-4070-81e9-94942109e560', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f030c460>]}
03:21:20.039142 [info ] [Thread-1  ]: 1 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.43s]
03:21:20.042310 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
03:21:20.048317 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.31 seconds
03:21:20.052886 [debug] [Thread-3  ]: finished collecting timing info
03:21:20.053740 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
03:21:20.114639 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'afc51979-efe3-4070-81e9-94942109e560', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f02cab80>]}
03:21:20.116907 [info ] [Thread-4  ]: 3 of 5 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.50s]
03:21:20.119580 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
03:21:20.204288 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'afc51979-efe3-4070-81e9-94942109e560', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f02ca8b0>]}
03:21:20.206310 [info ] [Thread-3  ]: 2 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.60s]
03:21:20.208442 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
03:21:20.212281 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.int_orders
03:21:20.214204 [info ] [Thread-2  ]: 4 of 5 START view model dbt_knguyen_refactor.int_orders......................... [RUN]
03:21:20.216977 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.int_orders"
03:21:20.217901 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.int_orders
03:21:20.219614 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.int_orders
03:21:20.226334 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.int_orders"
03:21:20.229446 [debug] [Thread-2  ]: finished collecting timing info
03:21:20.230278 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.int_orders
03:21:20.234854 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.int_orders"
03:21:20.242430 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.int_orders"
03:21:20.243547 [debug] [Thread-2  ]: On model.dbt_refactoring.int_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.int_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.int_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
    where payment_status != 'fail'
),
-----------
order_totals as (
    select
        order_id,
        payment_status,
        sum(payment_amount) as order_value_dollars
    from payments
    group by 1, 2
),
order_value_joined as (
    select
        orders.*,
        order_totals.payment_status,
        order_totals.order_value_dollars
    from orders
    left join order_totals
        on orders.order_id = order_totals.order_id
)
select * from order_value_joined
  );
03:21:20.245611 [debug] [Thread-2  ]: Opening a new connection, currently in state init
03:21:21.008609 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 0.76 seconds
03:21:21.013069 [debug] [Thread-2  ]: finished collecting timing info
03:21:21.014252 [debug] [Thread-2  ]: On model.dbt_refactoring.int_orders: Close
03:21:21.177581 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'afc51979-efe3-4070-81e9-94942109e560', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f02f5fa0>]}
03:21:21.179654 [info ] [Thread-2  ]: 4 of 5 OK created view model dbt_knguyen_refactor.int_orders.................... [[32mSUCCESS 1[0m in 0.96s]
03:21:21.181316 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.int_orders
03:21:21.185296 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.fct_customer_orders
03:21:21.186707 [info ] [Thread-4  ]: 5 of 5 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
03:21:21.190239 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
03:21:21.191509 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
03:21:21.194360 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.fct_customer_orders
03:21:21.202450 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
03:21:21.206070 [debug] [Thread-4  ]: finished collecting timing info
03:21:21.207495 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.fct_customer_orders
03:21:21.216703 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
03:21:21.228252 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
03:21:21.229158 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
orders as (
    select * from analytics.dbt_knguyen_refactor.int_orders
),
-----------

-----------
customer_order_history as (
    select 
        customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname,
        min(orders.order_date) as first_order_date,

        min(orders.valid_order_date) as first_non_returned_order_date,
        
        max(orders.valid_order_date) as most_recent_non_returned_order_date,
        
        COALESCE(max(orders.user_order_seq),0) as order_count,

        COALESCE(
            count(case 
                    when orders.valid_order_date is not null
                        then 1 
                end)
            ,0) as non_returned_order_count,

        sum(case 
                when orders.valid_order_date is not null
                    then orders.order_value_dollars
                else 0 
            end) as total_lifetime_value,

        sum(case 
                when orders.valid_order_date is not null
                    then orders.order_value_dollars
                else 0 
            end) / NULLIF(
                        count(case 
                                when orders.valid_order_date is not null
                                    then 1 
                              end)
                        ,0) as avg_non_returned_order_value,

        array_agg(distinct orders.order_id) as order_ids

    from orders

    join customers
    on orders.customer_id = customers.customer_id

    group by customers.customer_id,
        customers.full_name,
        customers.surname,
        customers.givenname

),
-- Final CTE
final as (
    select 
        orders.order_id,
        orders.customer_id,
        customers.surname,
        customers.givenname,
        first_order_date,
        order_count,
        total_lifetime_value,
        orders.order_value_dollars,
        orders.order_status,
        orders.payment_status
    from orders

    join customers
    on orders.customer_id = customers.id

    join customer_order_history
    on orders.customer_id = customer_order_history.customer_id

)
-- Simple Select statement
select * from final
  );
03:21:21.230488 [debug] [Thread-4  ]: Opening a new connection, currently in state closed
03:21:22.021838 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 0.79 seconds
03:21:22.026350 [debug] [Thread-4  ]: finished collecting timing info
03:21:22.027281 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: Close
03:21:22.173760 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'afc51979-efe3-4070-81e9-94942109e560', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f1f81070>]}
03:21:22.176887 [info ] [Thread-4  ]: 5 of 5 OK created view model dbt_knguyen_refactor.fct_customer_orders........... [[32mSUCCESS 1[0m in 0.98s]
03:21:22.178920 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.fct_customer_orders
03:21:22.182240 [debug] [MainThread]: Acquiring new snowflake connection "master"
03:21:22.183474 [info ] [MainThread]: 
03:21:22.185286 [info ] [MainThread]: Finished running 5 view models in 5.35s.
03:21:22.187291 [debug] [MainThread]: Connection 'master' was properly closed.
03:21:22.188721 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
03:21:22.191316 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__orders' was properly closed.
03:21:22.193079 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
03:21:22.194833 [debug] [MainThread]: Connection 'model.dbt_refactoring.int_orders' was properly closed.
03:21:22.212111 [info ] [MainThread]: 
03:21:22.213618 [info ] [MainThread]: [32mCompleted successfully[0m
03:21:22.214777 [info ] [MainThread]: 
03:21:22.217032 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
03:21:22.219365 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f1f1d4c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f16060d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f73f0897340>]}


============================== 2022-04-21 04:29:25.958569 | 7e380707-4edc-4de5-b9d2-a709ee31cc88 ==============================
04:29:25.958569 [info ] [MainThread]: Running with dbt=1.0.4
04:29:25.962015 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
04:29:25.962998 [debug] [MainThread]: Tracking: tracking
04:29:25.965616 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d1e587be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d1e587730>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d1e5875b0>]}
04:29:26.036711 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
04:29:26.038295 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/marts/fct_customer_orders.sql
04:29:26.055705 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
04:29:26.090910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7e380707-4edc-4de5-b9d2-a709ee31cc88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d1cbd10d0>]}
04:29:26.107849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7e380707-4edc-4de5-b9d2-a709ee31cc88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d1e4db9d0>]}
04:29:26.108972 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:29:26.113438 [info ] [MainThread]: 
04:29:26.115154 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:29:26.155686 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
04:29:26.192267 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
04:29:26.194773 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
04:29:26.196858 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:29:27.145211 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.95 seconds
04:29:27.149823 [debug] [ThreadPool]: On list_analytics: Close
04:29:27.303584 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:29:27.315289 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:29:27.316744 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:29:27.318227 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:29:28.149564 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.83 seconds
04:29:28.153931 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:29:28.295462 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:29:28.297259 [info ] [MainThread]: 
04:29:28.305667 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
04:29:28.306385 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
04:29:28.306776 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_stripe__payments
04:29:28.308850 [info ] [Thread-1  ]: 1 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
04:29:28.311296 [info ] [Thread-2  ]: 2 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
04:29:28.312688 [info ] [Thread-3  ]: 3 of 5 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
04:29:28.317986 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:29:28.319621 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:29:28.321895 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:29:28.323282 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
04:29:28.325300 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
04:29:28.326642 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
04:29:28.328991 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
04:29:28.331693 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
04:29:28.333625 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_stripe__payments
04:29:28.343933 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:29:28.348696 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:29:28.353143 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:29:28.360154 [debug] [Thread-1  ]: finished collecting timing info
04:29:28.366063 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
04:29:28.367455 [debug] [Thread-2  ]: finished collecting timing info
04:29:28.373745 [debug] [Thread-3  ]: finished collecting timing info
04:29:28.380232 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
04:29:28.391638 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
04:29:28.419948 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:29:28.421315 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:29:28.426450 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:29:28.433393 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:29:28.434703 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
04:29:28.436680 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:29:28.437781 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
04:29:28.439053 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:29:28.439780 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        case 
            when order_status not in ('returned','return_pending') 
                then order_date 
        end as valid_order_date,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
04:29:28.445235 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
04:29:28.446925 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
04:29:28.449288 [debug] [Thread-3  ]: Opening a new connection, currently in state init
04:29:29.484945 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 1.04 seconds
04:29:29.499936 [debug] [Thread-2  ]: finished collecting timing info
04:29:29.501665 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
04:29:29.901657 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.46 seconds
04:29:29.908314 [debug] [Thread-1  ]: finished collecting timing info
04:29:29.909539 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
04:29:29.924429 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.48 seconds
04:29:29.927671 [debug] [Thread-3  ]: finished collecting timing info
04:29:29.928619 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: Close
04:29:30.009704 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e380707-4edc-4de5-b9d2-a709ee31cc88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d047694c0>]}
04:29:30.013596 [info ] [Thread-2  ]: 2 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.69s]
04:29:30.015391 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
04:29:30.054077 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e380707-4edc-4de5-b9d2-a709ee31cc88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d070194f0>]}
04:29:30.055788 [info ] [Thread-1  ]: 1 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.74s]
04:29:30.057138 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
04:29:30.066546 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e380707-4edc-4de5-b9d2-a709ee31cc88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d047c9370>]}
04:29:30.067670 [info ] [Thread-3  ]: 3 of 5 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.74s]
04:29:30.069700 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
04:29:30.072719 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.int_orders
04:29:30.073850 [info ] [Thread-4  ]: 4 of 5 START view model dbt_knguyen_refactor.int_orders......................... [RUN]
04:29:30.077296 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.int_orders"
04:29:30.079598 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.int_orders
04:29:30.081755 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.int_orders
04:29:30.088924 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.int_orders"
04:29:30.094328 [debug] [Thread-4  ]: finished collecting timing info
04:29:30.096459 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.int_orders
04:29:30.108005 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.int_orders"
04:29:30.119137 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.int_orders"
04:29:30.120402 [debug] [Thread-4  ]: On model.dbt_refactoring.int_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.int_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.int_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
    where payment_status != 'fail'
),
-----------
order_totals as (
    select
        order_id,
        payment_status,
        sum(payment_amount) as order_value_dollars
    from payments
    group by 1, 2
),
order_value_joined as (
    select
        orders.*,
        order_totals.payment_status,
        order_totals.order_value_dollars
    from orders
    left join order_totals
        on orders.order_id = order_totals.order_id
)
select * from order_value_joined
  );
04:29:30.122562 [debug] [Thread-4  ]: Opening a new connection, currently in state init
04:29:30.838113 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 0.72 seconds
04:29:30.842538 [debug] [Thread-4  ]: finished collecting timing info
04:29:30.843604 [debug] [Thread-4  ]: On model.dbt_refactoring.int_orders: Close
04:29:30.993164 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e380707-4edc-4de5-b9d2-a709ee31cc88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d0478c5e0>]}
04:29:30.995187 [info ] [Thread-4  ]: 4 of 5 OK created view model dbt_knguyen_refactor.int_orders.................... [[32mSUCCESS 1[0m in 0.92s]
04:29:30.996876 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.int_orders
04:29:30.999678 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.fct_customer_orders
04:29:31.002552 [info ] [Thread-1  ]: 5 of 5 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
04:29:31.004702 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:29:31.005924 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
04:29:31.008547 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.fct_customer_orders
04:29:31.015013 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
04:29:31.019540 [debug] [Thread-1  ]: finished collecting timing info
04:29:31.020425 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.fct_customer_orders
04:29:31.025681 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
04:29:31.035450 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:29:31.036420 [debug] [Thread-1  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
orders as (
    select * from analytics.dbt_knguyen_refactor.int_orders
),
-----------
customer_orders as (
    select
        orders.*,
        customers.full_name,
        customers.surname,
        customers.givename,

        ---Customer level aggregations
        min(orders.order_date) over(
            partition by orders.customer_id
        ) as customer_first_order_date,

        min(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_first_non_returned_order_date,
        
        max(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_most_recent_non_returned_order_date,
        
        count(*) over(
            partition by orders.customer_id
        ) as customer_order_count,

        sum(nvl2(orders.valid_order_date, 1, 0)) over(
            partition by orders.customer_id
        ) as customer_non_returned_order_count,

        sum(nvl2(orders.valid_order_date, orders.order_value_dollars, 0)) over(
            partition by orders.customer_id
        ) as customer_total_lifetime_value,

        array_agg(distinct orders.order_id) over(
            partition by orders.customer_id
        ) as customer_order_ids

    from orders
    inner join customers
        on orders.customer_id = customers.customer_id
),
add_avg_order_values as (
    select 
        *,
        total_lifetime_value / non_returned_order_count 
            as customer_avg_non_returned_order_value
    from customer_orders
),
-----------

-- Final CTE
final as (
    select 
        order_id,
        customer_id,
        surname,
        givenname,
        customer_first_order_date as first_order_date,
        customer_order_count as order_count,
        customer_total_lifetime_value as total_lifetime_value,
        order_value_dollars,
        order_status,
        payment_status
    from add_avg_order_values

)
-- Simple Select statement
select * from final
  );
04:29:31.037800 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
04:29:31.683909 [debug] [Thread-1  ]: Snowflake adapter: Snowflake query id: 01a3bf6d-0000-574a-0000-469d0001f086
04:29:31.685547 [debug] [Thread-1  ]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 19 at position 8
invalid identifier 'CUSTOMERS.GIVENAME'
04:29:31.687798 [debug] [Thread-1  ]: finished collecting timing info
04:29:31.689720 [debug] [Thread-1  ]: On model.dbt_refactoring.fct_customer_orders: Close
04:29:31.834227 [debug] [Thread-1  ]: Database Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)
  000904 (42000): SQL compilation error: error line 19 at position 8
  invalid identifier 'CUSTOMERS.GIVENAME'
  compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
04:29:31.837057 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7e380707-4edc-4de5-b9d2-a709ee31cc88', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d047c0af0>]}
04:29:31.839085 [error] [Thread-1  ]: 5 of 5 ERROR creating view model dbt_knguyen_refactor.fct_customer_orders....... [[31mERROR[0m in 0.83s]
04:29:31.840849 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.fct_customer_orders
04:29:31.845528 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:29:31.847792 [info ] [MainThread]: 
04:29:31.849318 [info ] [MainThread]: Finished running 5 view models in 5.73s.
04:29:31.851743 [debug] [MainThread]: Connection 'master' was properly closed.
04:29:31.854320 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__orders' was properly closed.
04:29:31.855911 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
04:29:31.857496 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_stripe__payments' was properly closed.
04:29:31.858978 [debug] [MainThread]: Connection 'model.dbt_refactoring.int_orders' was properly closed.
04:29:31.875927 [info ] [MainThread]: 
04:29:31.877571 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
04:29:31.879456 [info ] [MainThread]: 
04:29:31.882248 [error] [MainThread]: [33mDatabase Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)[0m
04:29:31.886196 [error] [MainThread]:   000904 (42000): SQL compilation error: error line 19 at position 8
04:29:31.888583 [error] [MainThread]:   invalid identifier 'CUSTOMERS.GIVENAME'
04:29:31.890914 [error] [MainThread]:   compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
04:29:31.893887 [info ] [MainThread]: 
04:29:31.896460 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
04:29:31.900481 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d1e4dba60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d1e4db190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f3d07d178e0>]}


============================== 2022-04-21 04:30:14.815425 | e7b826a5-e474-427a-9ff4-bb0461e02edd ==============================
04:30:14.815425 [info ] [MainThread]: Running with dbt=1.0.4
04:30:14.816922 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
04:30:14.818642 [debug] [MainThread]: Tracking: tracking
04:30:14.820764 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cedc31c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cedc3130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cedc3d90>]}
04:30:14.883683 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
04:30:14.885084 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/marts/fct_customer_orders.sql
04:30:14.902119 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
04:30:14.934255 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e7b826a5-e474-427a-9ff4-bb0461e02edd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cec170d0>]}
04:30:14.952111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e7b826a5-e474-427a-9ff4-bb0461e02edd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cecdd9d0>]}
04:30:14.953416 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:30:14.957190 [info ] [MainThread]: 
04:30:14.958813 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:30:14.961566 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
04:30:14.983945 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
04:30:14.985428 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
04:30:14.987365 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:30:15.900580 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.91 seconds
04:30:15.905094 [debug] [ThreadPool]: On list_analytics: Close
04:30:16.065468 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:30:16.076137 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:30:16.076907 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:30:16.078071 [debug] [ThreadPool]: Opening a new connection, currently in state closed
04:30:16.659921 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.58 seconds
04:30:16.664041 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:30:16.812346 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:30:16.814036 [info ] [MainThread]: 
04:30:16.824225 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
04:30:16.825868 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
04:30:16.830944 [info ] [Thread-2  ]: 2 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
04:30:16.833225 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:30:16.826656 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_stripe__payments
04:30:16.827413 [info ] [Thread-1  ]: 1 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
04:30:16.834610 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
04:30:16.840339 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
04:30:16.838856 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:30:16.836864 [info ] [Thread-3  ]: 3 of 5 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
04:30:16.847433 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:30:16.848621 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
04:30:16.854052 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
04:30:16.851137 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:30:16.857786 [debug] [Thread-2  ]: finished collecting timing info
04:30:16.863600 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:30:16.865071 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
04:30:16.867229 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
04:30:16.871958 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_stripe__payments
04:30:16.884403 [debug] [Thread-1  ]: finished collecting timing info
04:30:16.913183 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
04:30:16.898106 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:30:16.926292 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:30:16.929938 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:30:16.936473 [debug] [Thread-3  ]: finished collecting timing info
04:30:16.938670 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
04:30:16.942071 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:30:16.943310 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:30:16.948479 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:30:16.949344 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
04:30:16.950700 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        case 
            when order_status not in ('returned','return_pending') 
                then order_date 
        end as valid_order_date,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
04:30:16.953517 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
04:30:16.955293 [debug] [Thread-2  ]: Opening a new connection, currently in state init
04:30:16.957412 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:30:16.969364 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
04:30:16.972371 [debug] [Thread-3  ]: Opening a new connection, currently in state init
04:30:18.170243 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.2 seconds
04:30:18.186256 [debug] [Thread-3  ]: finished collecting timing info
04:30:18.189175 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_stripe__payments: Close
04:30:18.214212 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 1.26 seconds
04:30:18.218188 [debug] [Thread-2  ]: finished collecting timing info
04:30:18.220312 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.27 seconds
04:30:18.222181 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
04:30:18.226690 [debug] [Thread-1  ]: finished collecting timing info
04:30:18.237508 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
04:30:18.406968 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7b826a5-e474-427a-9ff4-bb0461e02edd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71b4fcae50>]}
04:30:18.410701 [info ] [Thread-3  ]: 3 of 5 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.56s]
04:30:18.412582 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7b826a5-e474-427a-9ff4-bb0461e02edd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cc088f70>]}
04:30:18.413657 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
04:30:18.414848 [info ] [Thread-2  ]: 2 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.58s]
04:30:18.418694 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
04:30:18.420955 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.int_orders
04:30:18.422419 [info ] [Thread-4  ]: 4 of 5 START view model dbt_knguyen_refactor.int_orders......................... [RUN]
04:30:18.423760 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.int_orders"
04:30:18.425362 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.int_orders
04:30:18.427827 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.int_orders
04:30:18.433942 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.int_orders"
04:30:18.437810 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7b826a5-e474-427a-9ff4-bb0461e02edd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cc591a30>]}
04:30:18.439201 [info ] [Thread-1  ]: 1 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.60s]
04:30:18.439702 [debug] [Thread-4  ]: finished collecting timing info
04:30:18.441413 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
04:30:18.442710 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.int_orders
04:30:18.452589 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.int_orders"
04:30:18.459064 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.int_orders"
04:30:18.460337 [debug] [Thread-4  ]: On model.dbt_refactoring.int_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.int_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.int_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
    where payment_status != 'fail'
),
-----------
order_totals as (
    select
        order_id,
        payment_status,
        sum(payment_amount) as order_value_dollars
    from payments
    group by 1, 2
),
order_value_joined as (
    select
        orders.*,
        order_totals.payment_status,
        order_totals.order_value_dollars
    from orders
    left join order_totals
        on orders.order_id = order_totals.order_id
)
select * from order_value_joined
  );
04:30:18.462676 [debug] [Thread-4  ]: Opening a new connection, currently in state init
04:30:19.225410 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 0.76 seconds
04:30:19.230788 [debug] [Thread-4  ]: finished collecting timing info
04:30:19.231731 [debug] [Thread-4  ]: On model.dbt_refactoring.int_orders: Close
04:30:19.380229 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7b826a5-e474-427a-9ff4-bb0461e02edd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71b4f7dac0>]}
04:30:19.382461 [info ] [Thread-4  ]: 4 of 5 OK created view model dbt_knguyen_refactor.int_orders.................... [[32mSUCCESS 1[0m in 0.96s]
04:30:19.384416 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.int_orders
04:30:19.387117 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.fct_customer_orders
04:30:19.388511 [info ] [Thread-2  ]: 5 of 5 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
04:30:19.390940 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:30:19.392129 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
04:30:19.394351 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.fct_customer_orders
04:30:19.401616 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
04:30:19.406156 [debug] [Thread-2  ]: finished collecting timing info
04:30:19.407092 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.fct_customer_orders
04:30:19.412495 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
04:30:19.422290 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:30:19.423843 [debug] [Thread-2  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
orders as (
    select * from analytics.dbt_knguyen_refactor.int_orders
),
-----------
customer_orders as (
    select
        orders.*,
        customers.full_name,
        customers.surname,
        customers.givenname,

        ---Customer level aggregations
        min(orders.order_date) over(
            partition by orders.customer_id
        ) as customer_first_order_date,

        min(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_first_non_returned_order_date,
        
        max(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_most_recent_non_returned_order_date,
        
        count(*) over(
            partition by orders.customer_id
        ) as customer_order_count,

        sum(nvl2(orders.valid_order_date, 1, 0)) over(
            partition by orders.customer_id
        ) as customer_non_returned_order_count,

        sum(nvl2(orders.valid_order_date, orders.order_value_dollars, 0)) over(
            partition by orders.customer_id
        ) as customer_total_lifetime_value,

        array_agg(distinct orders.order_id) over(
            partition by orders.customer_id
        ) as customer_order_ids

    from orders
    inner join customers
        on orders.customer_id = customers.customer_id
),
add_avg_order_values as (
    select 
        *,
        total_lifetime_value / non_returned_order_count 
            as customer_avg_non_returned_order_value
    from customer_orders
),
-----------

-- Final CTE
final as (
    select 
        order_id,
        customer_id,
        surname,
        givenname,
        customer_first_order_date as first_order_date,
        customer_order_count as order_count,
        customer_total_lifetime_value as total_lifetime_value,
        order_value_dollars,
        order_status,
        payment_status
    from add_avg_order_values

)
-- Simple Select statement
select * from final
  );
04:30:19.427176 [debug] [Thread-2  ]: Opening a new connection, currently in state closed
04:30:20.102827 [debug] [Thread-2  ]: Snowflake adapter: Snowflake query id: 01a3bf6e-0000-5727-0000-469d0001e07a
04:30:20.104258 [debug] [Thread-2  ]: Snowflake adapter: Snowflake error: 000904 (42000): SQL compilation error: error line 57 at position 8
invalid identifier 'TOTAL_LIFETIME_VALUE'
04:30:20.106087 [debug] [Thread-2  ]: finished collecting timing info
04:30:20.107873 [debug] [Thread-2  ]: On model.dbt_refactoring.fct_customer_orders: Close
04:30:20.253976 [debug] [Thread-2  ]: Database Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)
  000904 (42000): SQL compilation error: error line 57 at position 8
  invalid identifier 'TOTAL_LIFETIME_VALUE'
  compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
04:30:20.256624 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e7b826a5-e474-427a-9ff4-bb0461e02edd', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cc075f70>]}
04:30:20.259300 [error] [Thread-2  ]: 5 of 5 ERROR creating view model dbt_knguyen_refactor.fct_customer_orders....... [[31mERROR[0m in 0.87s]
04:30:20.261117 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.fct_customer_orders
04:30:20.265467 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:30:20.267700 [info ] [MainThread]: 
04:30:20.269053 [info ] [MainThread]: Finished running 5 view models in 5.31s.
04:30:20.271187 [debug] [MainThread]: Connection 'master' was properly closed.
04:30:20.273579 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
04:30:20.275238 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
04:30:20.277438 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_stripe__payments' was properly closed.
04:30:20.279923 [debug] [MainThread]: Connection 'model.dbt_refactoring.int_orders' was properly closed.
04:30:20.298075 [info ] [MainThread]: 
04:30:20.300949 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
04:30:20.303178 [info ] [MainThread]: 
04:30:20.306193 [error] [MainThread]: [33mDatabase Error in model fct_customer_orders (models/marts/fct_customer_orders.sql)[0m
04:30:20.308299 [error] [MainThread]:   000904 (42000): SQL compilation error: error line 57 at position 8
04:30:20.311746 [error] [MainThread]:   invalid identifier 'TOTAL_LIFETIME_VALUE'
04:30:20.318772 [error] [MainThread]:   compiled SQL at target/run/dbt_refactoring/models/marts/fct_customer_orders.sql
04:30:20.320466 [info ] [MainThread]: 
04:30:20.322520 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
04:30:20.325735 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cec9f4c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71ceca51c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f71cc57f1c0>]}


============================== 2022-04-21 04:31:30.088274 | 65c37896-d931-41fd-9ddc-dc5c6fd36ddb ==============================
04:31:30.088274 [info ] [MainThread]: Running with dbt=1.0.4
04:31:30.089957 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=['+fct_customer_orders'], exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
04:31:30.093256 [debug] [MainThread]: Tracking: tracking
04:31:30.095150 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f307d1c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f307d130>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f307dd90>]}
04:31:30.159864 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
04:31:30.161746 [debug] [MainThread]: Partial parsing: updated file: dbt_refactoring://models/marts/fct_customer_orders.sql
04:31:30.178942 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
04:31:30.211628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '65c37896-d931-41fd-9ddc-dc5c6fd36ddb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f16cc0d0>]}
04:31:30.226722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '65c37896-d931-41fd-9ddc-dc5c6fd36ddb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f1fbd9d0>]}
04:31:30.227804 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 0 analyses, 179 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:31:30.231904 [info ] [MainThread]: 
04:31:30.233529 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:31:30.236644 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
04:31:30.262556 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
04:31:30.264394 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
04:31:30.266482 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:31:31.188182 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.92 seconds
04:31:31.192295 [debug] [ThreadPool]: On list_analytics: Close
04:31:31.342810 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:31:31.357365 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:31:31.358674 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:31:31.359883 [debug] [ThreadPool]: Opening a new connection, currently in state closed
04:31:31.935611 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.58 seconds
04:31:31.940147 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:31:32.081508 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:31:32.082936 [info ] [MainThread]: 
04:31:32.092026 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
04:31:32.093219 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
04:31:32.093971 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.stg_stripe__payments
04:31:32.095154 [info ] [Thread-1  ]: 1 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
04:31:32.096980 [info ] [Thread-3  ]: 2 of 5 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
04:31:32.098794 [info ] [Thread-4  ]: 3 of 5 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
04:31:32.104286 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:31:32.105182 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:31:32.106028 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:31:32.107468 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
04:31:32.109129 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
04:31:32.112346 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
04:31:32.114669 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
04:31:32.115940 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
04:31:32.118298 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.stg_stripe__payments
04:31:32.126367 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:31:32.131359 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:31:32.135324 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:31:32.140813 [debug] [Thread-1  ]: finished collecting timing info
04:31:32.143057 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
04:31:32.144064 [debug] [Thread-3  ]: finished collecting timing info
04:31:32.161637 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
04:31:32.183685 [debug] [Thread-4  ]: finished collecting timing info
04:31:32.194831 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
04:31:32.206305 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:31:32.208718 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:31:32.213775 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:31:32.219321 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:31:32.223693 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:31:32.224044 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
04:31:32.225038 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        case 
            when order_status not in ('returned','return_pending') 
                then order_date 
        end as valid_order_date,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
04:31:32.227020 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:31:32.227936 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
04:31:32.229361 [debug] [Thread-3  ]: Opening a new connection, currently in state init
04:31:32.230827 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
04:31:32.243671 [debug] [Thread-4  ]: Opening a new connection, currently in state init
04:31:33.327759 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.1 seconds
04:31:33.340644 [debug] [Thread-1  ]: finished collecting timing info
04:31:33.344057 [debug] [Thread-1  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
04:31:33.345703 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 1.1 seconds
04:31:33.361315 [debug] [Thread-4  ]: finished collecting timing info
04:31:33.363663 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: Close
04:31:33.479261 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.25 seconds
04:31:33.483453 [debug] [Thread-3  ]: finished collecting timing info
04:31:33.484669 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
04:31:33.492979 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '65c37896-d931-41fd-9ddc-dc5c6fd36ddb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f0338040>]}
04:31:33.494347 [info ] [Thread-1  ]: 1 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.39s]
04:31:33.497042 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
04:31:33.508809 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '65c37896-d931-41fd-9ddc-dc5c6fd36ddb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f02b8d90>]}
04:31:33.511206 [info ] [Thread-4  ]: 3 of 5 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.40s]
04:31:33.513870 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
04:31:33.625481 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '65c37896-d931-41fd-9ddc-dc5c6fd36ddb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f02a7bb0>]}
04:31:33.627196 [info ] [Thread-3  ]: 2 of 5 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.52s]
04:31:33.628760 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
04:31:33.630952 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.int_orders
04:31:33.631983 [info ] [Thread-2  ]: 4 of 5 START view model dbt_knguyen_refactor.int_orders......................... [RUN]
04:31:33.634025 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.int_orders"
04:31:33.635791 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.int_orders
04:31:33.637899 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.int_orders
04:31:33.647538 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.int_orders"
04:31:33.652079 [debug] [Thread-2  ]: finished collecting timing info
04:31:33.653367 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.int_orders
04:31:33.659213 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.int_orders"
04:31:33.665092 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.int_orders"
04:31:33.665866 [debug] [Thread-2  ]: On model.dbt_refactoring.int_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.int_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.int_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
    where payment_status != 'fail'
),
-----------
order_totals as (
    select
        order_id,
        payment_status,
        sum(payment_amount) as order_value_dollars
    from payments
    group by 1, 2
),
order_value_joined as (
    select
        orders.*,
        order_totals.payment_status,
        order_totals.order_value_dollars
    from orders
    left join order_totals
        on orders.order_id = order_totals.order_id
)
select * from order_value_joined
  );
04:31:33.667737 [debug] [Thread-2  ]: Opening a new connection, currently in state init
04:31:34.408581 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 0.74 seconds
04:31:34.412649 [debug] [Thread-2  ]: finished collecting timing info
04:31:34.413699 [debug] [Thread-2  ]: On model.dbt_refactoring.int_orders: Close
04:31:34.553586 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '65c37896-d931-41fd-9ddc-dc5c6fd36ddb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f0795640>]}
04:31:34.555438 [info ] [Thread-2  ]: 4 of 5 OK created view model dbt_knguyen_refactor.int_orders.................... [[32mSUCCESS 1[0m in 0.92s]
04:31:34.558004 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.int_orders
04:31:34.561098 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.fct_customer_orders
04:31:34.563379 [info ] [Thread-4  ]: 5 of 5 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
04:31:34.565960 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:31:34.567478 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
04:31:34.569404 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.fct_customer_orders
04:31:34.577016 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
04:31:34.581114 [debug] [Thread-4  ]: finished collecting timing info
04:31:34.582844 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.fct_customer_orders
04:31:34.590836 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
04:31:34.599779 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:31:34.601912 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
orders as (
    select * from analytics.dbt_knguyen_refactor.int_orders
),
-----------
customer_orders as (
    select
        orders.*,
        customers.full_name,
        customers.surname,
        customers.givenname,

        ---Customer level aggregations
        min(orders.order_date) over(
            partition by orders.customer_id
        ) as customer_first_order_date,

        min(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_first_non_returned_order_date,
        
        max(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_most_recent_non_returned_order_date,
        
        count(*) over(
            partition by orders.customer_id
        ) as customer_order_count,

        sum(nvl2(orders.valid_order_date, 1, 0)) over(
            partition by orders.customer_id
        ) as customer_non_returned_order_count,

        sum(nvl2(orders.valid_order_date, orders.order_value_dollars, 0)) over(
            partition by orders.customer_id
        ) as customer_total_lifetime_value,

        array_agg(distinct orders.order_id) over(
            partition by orders.customer_id
        ) as customer_order_ids

    from orders
    inner join customers
        on orders.customer_id = customers.customer_id
),
add_avg_order_values as (
    select 
        *,
        customer_total_lifetime_value / customer_non_returned_order_count 
            as customer_avg_non_returned_order_value
    from customer_orders
),
-----------

-- Final CTE
final as (
    select 
        order_id,
        customer_id,
        surname,
        givenname,
        customer_first_order_date as first_order_date,
        customer_order_count as order_count,
        customer_total_lifetime_value as total_lifetime_value,
        order_value_dollars,
        order_status,
        payment_status
    from add_avg_order_values

)
-- Simple Select statement
select * from final
  );
04:31:34.604476 [debug] [Thread-4  ]: Opening a new connection, currently in state closed
04:31:35.502059 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 0.9 seconds
04:31:35.506295 [debug] [Thread-4  ]: finished collecting timing info
04:31:35.507438 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: Close
04:31:35.662959 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '65c37896-d931-41fd-9ddc-dc5c6fd36ddb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f03308e0>]}
04:31:35.665008 [info ] [Thread-4  ]: 5 of 5 OK created view model dbt_knguyen_refactor.fct_customer_orders........... [[32mSUCCESS 1[0m in 1.10s]
04:31:35.667233 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.fct_customer_orders
04:31:35.671946 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:31:35.673417 [info ] [MainThread]: 
04:31:35.675718 [info ] [MainThread]: Finished running 5 view models in 5.44s.
04:31:35.677726 [debug] [MainThread]: Connection 'master' was properly closed.
04:31:35.680000 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
04:31:35.681844 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__orders' was properly closed.
04:31:35.683859 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
04:31:35.686084 [debug] [MainThread]: Connection 'model.dbt_refactoring.int_orders' was properly closed.
04:31:35.708441 [info ] [MainThread]: 
04:31:35.710680 [info ] [MainThread]: [32mCompleted successfully[0m
04:31:35.713244 [info ] [MainThread]: 
04:31:35.717963 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=0 SKIP=0 TOTAL=5
04:31:35.722043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f02fbd30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f1fbdbb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2f0330d60>]}


============================== 2022-04-21 04:39:56.315638 | 5df6ee8b-06d3-45ae-a4c1-a279d3b94d0e ==============================
04:39:56.315638 [info ] [MainThread]: Running with dbt=1.0.4
04:39:56.319094 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, defer=None, state=None, cls=<class 'dbt.task.deps.DepsTask'>, which='deps', rpc_method='deps')
04:39:56.320575 [debug] [MainThread]: Tracking: tracking
04:39:56.328560 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd07592cb20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd07592c7c0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd07592cfa0>]}
04:39:56.333383 [debug] [MainThread]: Set downloads directory='/tmp/dbt-downloads-pljno94w'
04:39:56.334950 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/index.json
04:39:56.703978 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/index.json 200
04:39:56.706502 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper.json
04:39:56.890885 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper.json 200
04:39:56.897935 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper/0.5.0.json
04:39:57.069629 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper/0.5.0.json 200
04:39:57.071683 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json
04:39:57.232470 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json 200
04:39:57.276119 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.8.4.json
04:39:57.457946 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.8.4.json 200
04:39:57.460398 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper.json
04:39:57.646425 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper.json 200
04:39:57.653865 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json
04:39:57.830231 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils.json 200
04:39:57.874083 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper/0.5.0.json
04:39:58.097466 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/audit_helper/0.5.0.json 200
04:39:58.100010 [debug] [MainThread]: Making package registry request: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.8.4.json
04:39:58.279358 [debug] [MainThread]: Response from registry: GET https://hub.getdbt.com/api/v1/dbt-labs/dbt_utils/0.8.4.json 200
04:39:58.281520 [info ] [MainThread]: Installing dbt-labs/audit_helper
04:39:59.114951 [info ] [MainThread]:   Installed from version 0.5.0
04:39:59.116308 [info ] [MainThread]:   Up to date!
04:39:59.118721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'package', 'label': '5df6ee8b-06d3-45ae-a4c1-a279d3b94d0e', 'property_': 'install', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd0758b1310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd0758b1340>]}
04:39:59.121202 [info ] [MainThread]: Installing dbt-labs/dbt_utils
04:40:01.813944 [info ] [MainThread]:   Installed from version 0.8.4
04:40:01.814988 [info ] [MainThread]:   Up to date!
04:40:01.816418 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'package', 'label': '5df6ee8b-06d3-45ae-a4c1-a279d3b94d0e', 'property_': 'install', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd0758b1b50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd07580b7f0>]}
04:40:01.819452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd075884ca0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd0758b6d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd0758b13d0>]}


============================== 2022-04-21 04:46:23.080780 | 95221391-fdfa-43e9-8052-05bed00f159b ==============================
04:46:23.080780 [info ] [MainThread]: Running with dbt=1.0.4
04:46:23.084926 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, threads=None, select=None, exclude=None, selector_name=None, state=None, defer=None, full_refresh=False, cls=<class 'dbt.task.run.RunTask'>, which='run', rpc_method='run')
04:46:23.086468 [debug] [MainThread]: Tracking: tracking
04:46:23.088617 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd357278d60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd357278d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd357278af0>]}
04:46:23.148865 [info ] [MainThread]: Unable to do partial parsing because a project dependency has been added
04:46:23.150843 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3572700d0>]}
04:46:23.362318 [debug] [MainThread]: Parsing macros/adapters.sql
04:46:23.429537 [debug] [MainThread]: Parsing macros/catalog.sql
04:46:23.434174 [debug] [MainThread]: Parsing macros/materializations/seed.sql
04:46:23.442751 [debug] [MainThread]: Parsing macros/materializations/incremental.sql
04:46:23.456456 [debug] [MainThread]: Parsing macros/materializations/merge.sql
04:46:23.463146 [debug] [MainThread]: Parsing macros/materializations/view.sql
04:46:23.466174 [debug] [MainThread]: Parsing macros/materializations/table.sql
04:46:23.471720 [debug] [MainThread]: Parsing macros/materializations/snapshot.sql
04:46:23.473733 [debug] [MainThread]: Parsing macros/materializations/configs.sql
04:46:23.477769 [debug] [MainThread]: Parsing macros/materializations/hooks.sql
04:46:23.484067 [debug] [MainThread]: Parsing macros/materializations/snapshots/strategies.sql
04:46:23.509934 [debug] [MainThread]: Parsing macros/materializations/snapshots/helpers.sql
04:46:23.529672 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot_merge.sql
04:46:23.533434 [debug] [MainThread]: Parsing macros/materializations/snapshots/snapshot.sql
04:46:23.552262 [debug] [MainThread]: Parsing macros/materializations/tests/test.sql
04:46:23.560964 [debug] [MainThread]: Parsing macros/materializations/tests/helpers.sql
04:46:23.564729 [debug] [MainThread]: Parsing macros/materializations/tests/where_subquery.sql
04:46:23.568075 [debug] [MainThread]: Parsing macros/materializations/seeds/seed.sql
04:46:23.578097 [debug] [MainThread]: Parsing macros/materializations/seeds/helpers.sql
04:46:23.605188 [debug] [MainThread]: Parsing macros/materializations/models/view/create_view_as.sql
04:46:23.610407 [debug] [MainThread]: Parsing macros/materializations/models/view/helpers.sql
04:46:23.613189 [debug] [MainThread]: Parsing macros/materializations/models/view/view.sql
04:46:23.624267 [debug] [MainThread]: Parsing macros/materializations/models/view/create_or_replace_view.sql
04:46:23.629152 [debug] [MainThread]: Parsing macros/materializations/models/incremental/on_schema_change.sql
04:46:23.655087 [debug] [MainThread]: Parsing macros/materializations/models/incremental/incremental.sql
04:46:23.671205 [debug] [MainThread]: Parsing macros/materializations/models/incremental/merge.sql
04:46:23.690483 [debug] [MainThread]: Parsing macros/materializations/models/incremental/column_helpers.sql
04:46:23.698980 [debug] [MainThread]: Parsing macros/materializations/models/incremental/is_incremental.sql
04:46:23.701969 [debug] [MainThread]: Parsing macros/materializations/models/table/create_table_as.sql
04:46:23.707516 [debug] [MainThread]: Parsing macros/materializations/models/table/table.sql
04:46:23.719395 [debug] [MainThread]: Parsing macros/generic_test_sql/not_null.sql
04:46:23.721057 [debug] [MainThread]: Parsing macros/generic_test_sql/unique.sql
04:46:23.722901 [debug] [MainThread]: Parsing macros/generic_test_sql/accepted_values.sql
04:46:23.725488 [debug] [MainThread]: Parsing macros/generic_test_sql/relationships.sql
04:46:23.727757 [debug] [MainThread]: Parsing macros/etc/datetime.sql
04:46:23.741232 [debug] [MainThread]: Parsing macros/etc/statement.sql
04:46:23.748850 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_alias.sql
04:46:23.751752 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_schema.sql
04:46:23.756101 [debug] [MainThread]: Parsing macros/get_custom_name/get_custom_database.sql
04:46:23.759164 [debug] [MainThread]: Parsing macros/adapters/schema.sql
04:46:23.763117 [debug] [MainThread]: Parsing macros/adapters/indexes.sql
04:46:23.767713 [debug] [MainThread]: Parsing macros/adapters/metadata.sql
04:46:23.779125 [debug] [MainThread]: Parsing macros/adapters/persist_docs.sql
04:46:23.786392 [debug] [MainThread]: Parsing macros/adapters/freshness.sql
04:46:23.791683 [debug] [MainThread]: Parsing macros/adapters/relation.sql
04:46:23.806356 [debug] [MainThread]: Parsing macros/adapters/columns.sql
04:46:23.823049 [debug] [MainThread]: Parsing tests/generic/builtin.sql
04:46:23.828126 [debug] [MainThread]: Parsing macros/compare_column_values.sql
04:46:23.840480 [debug] [MainThread]: Parsing macros/compare_queries.sql
04:46:23.845015 [debug] [MainThread]: Parsing macros/compare_relation_columns.sql
04:46:23.854119 [debug] [MainThread]: Parsing macros/compare_relations.sql
04:46:23.859712 [debug] [MainThread]: Parsing macros/cross_db_utils/_is_ephemeral.sql
04:46:23.863250 [debug] [MainThread]: Parsing macros/cross_db_utils/_is_relation.sql
04:46:23.866622 [debug] [MainThread]: Parsing macros/cross_db_utils/any_value.sql
04:46:23.870652 [debug] [MainThread]: Parsing macros/cross_db_utils/bool_or.sql
04:46:23.873583 [debug] [MainThread]: Parsing macros/cross_db_utils/cast_bool_to_text.sql
04:46:23.876197 [debug] [MainThread]: Parsing macros/cross_db_utils/concat.sql
04:46:23.878355 [debug] [MainThread]: Parsing macros/cross_db_utils/current_timestamp.sql
04:46:23.884117 [debug] [MainThread]: Parsing macros/cross_db_utils/datatypes.sql
04:46:23.893053 [debug] [MainThread]: Parsing macros/cross_db_utils/date_trunc.sql
04:46:23.897988 [debug] [MainThread]: Parsing macros/cross_db_utils/dateadd.sql
04:46:23.904962 [debug] [MainThread]: Parsing macros/cross_db_utils/datediff.sql
04:46:23.922687 [debug] [MainThread]: Parsing macros/cross_db_utils/escape_single_quotes.sql
04:46:23.926214 [debug] [MainThread]: Parsing macros/cross_db_utils/except.sql
04:46:23.928767 [debug] [MainThread]: Parsing macros/cross_db_utils/hash.sql
04:46:23.931538 [debug] [MainThread]: Parsing macros/cross_db_utils/identifier.sql
04:46:23.934658 [debug] [MainThread]: Parsing macros/cross_db_utils/intersect.sql
04:46:23.937039 [debug] [MainThread]: Parsing macros/cross_db_utils/last_day.sql
04:46:23.944509 [debug] [MainThread]: Parsing macros/cross_db_utils/length.sql
04:46:23.947369 [debug] [MainThread]: Parsing macros/cross_db_utils/listagg.sql
04:46:23.962795 [debug] [MainThread]: Parsing macros/cross_db_utils/literal.sql
04:46:23.965832 [debug] [MainThread]: Parsing macros/cross_db_utils/position.sql
04:46:23.969121 [debug] [MainThread]: Parsing macros/cross_db_utils/replace.sql
04:46:23.971630 [debug] [MainThread]: Parsing macros/cross_db_utils/right.sql
04:46:23.976662 [debug] [MainThread]: Parsing macros/cross_db_utils/safe_cast.sql
04:46:23.980455 [debug] [MainThread]: Parsing macros/cross_db_utils/split_part.sql
04:46:23.984037 [debug] [MainThread]: Parsing macros/cross_db_utils/width_bucket.sql
04:46:23.993231 [debug] [MainThread]: Parsing macros/generic_tests/accepted_range.sql
04:46:23.998092 [debug] [MainThread]: Parsing macros/generic_tests/at_least_one.sql
04:46:24.000736 [debug] [MainThread]: Parsing macros/generic_tests/cardinality_equality.sql
04:46:24.005378 [debug] [MainThread]: Parsing macros/generic_tests/equal_rowcount.sql
04:46:24.008931 [debug] [MainThread]: Parsing macros/generic_tests/equality.sql
04:46:24.015694 [debug] [MainThread]: Parsing macros/generic_tests/expression_is_true.sql
04:46:24.019417 [debug] [MainThread]: Parsing macros/generic_tests/fewer_rows_than.sql
04:46:24.023811 [debug] [MainThread]: Parsing macros/generic_tests/mutually_exclusive_ranges.sql
04:46:24.040194 [debug] [MainThread]: Parsing macros/generic_tests/not_accepted_values.sql
04:46:24.044916 [debug] [MainThread]: Parsing macros/generic_tests/not_constant.sql
04:46:24.047539 [debug] [MainThread]: Parsing macros/generic_tests/not_null_proportion.sql
04:46:24.051855 [debug] [MainThread]: Parsing macros/generic_tests/recency.sql
04:46:24.055498 [debug] [MainThread]: Parsing macros/generic_tests/relationships_where.sql
04:46:24.062225 [debug] [MainThread]: Parsing macros/generic_tests/sequential_values.sql
04:46:24.067350 [debug] [MainThread]: Parsing macros/generic_tests/test_not_null_where.sql
04:46:24.070754 [debug] [MainThread]: Parsing macros/generic_tests/test_unique_where.sql
04:46:24.073861 [debug] [MainThread]: Parsing macros/generic_tests/unique_combination_of_columns.sql
04:46:24.078775 [debug] [MainThread]: Parsing macros/jinja_helpers/log_info.sql
04:46:24.081154 [debug] [MainThread]: Parsing macros/jinja_helpers/pretty_log_format.sql
04:46:24.083380 [debug] [MainThread]: Parsing macros/jinja_helpers/pretty_time.sql
04:46:24.085523 [debug] [MainThread]: Parsing macros/jinja_helpers/slugify.sql
04:46:24.087983 [debug] [MainThread]: Parsing macros/materializations/insert_by_period_materialization.sql
04:46:24.125250 [debug] [MainThread]: Parsing macros/sql/date_spine.sql
04:46:24.132901 [debug] [MainThread]: Parsing macros/sql/deduplicate.sql
04:46:24.138817 [debug] [MainThread]: Parsing macros/sql/generate_series.sql
04:46:24.145983 [debug] [MainThread]: Parsing macros/sql/get_column_values.sql
04:46:24.154486 [debug] [MainThread]: Parsing macros/sql/get_filtered_columns_in_relation.sql
04:46:24.159347 [debug] [MainThread]: Parsing macros/sql/get_query_results_as_dict.sql
04:46:24.163067 [debug] [MainThread]: Parsing macros/sql/get_relations_by_pattern.sql
04:46:24.168530 [debug] [MainThread]: Parsing macros/sql/get_relations_by_prefix.sql
04:46:24.174324 [debug] [MainThread]: Parsing macros/sql/get_table_types_sql.sql
04:46:24.177191 [debug] [MainThread]: Parsing macros/sql/get_tables_by_pattern_sql.sql
04:46:24.187610 [debug] [MainThread]: Parsing macros/sql/get_tables_by_prefix_sql.sql
04:46:24.190856 [debug] [MainThread]: Parsing macros/sql/groupby.sql
04:46:24.193253 [debug] [MainThread]: Parsing macros/sql/haversine_distance.sql
04:46:24.202412 [debug] [MainThread]: Parsing macros/sql/nullcheck.sql
04:46:24.205502 [debug] [MainThread]: Parsing macros/sql/nullcheck_table.sql
04:46:24.208427 [debug] [MainThread]: Parsing macros/sql/pivot.sql
04:46:24.215825 [debug] [MainThread]: Parsing macros/sql/safe_add.sql
04:46:24.218769 [debug] [MainThread]: Parsing macros/sql/star.sql
04:46:24.224026 [debug] [MainThread]: Parsing macros/sql/surrogate_key.sql
04:46:24.230055 [debug] [MainThread]: Parsing macros/sql/union.sql
04:46:24.248079 [debug] [MainThread]: Parsing macros/sql/unpivot.sql
04:46:24.261489 [debug] [MainThread]: Parsing macros/web/get_url_host.sql
04:46:24.265311 [debug] [MainThread]: Parsing macros/web/get_url_parameter.sql
04:46:24.268454 [debug] [MainThread]: Parsing macros/web/get_url_path.sql
04:46:24.799335 [debug] [MainThread]: 1699: static parser successfully parsed legacy/customer_orders.sql
04:46:24.816923 [debug] [MainThread]: 1699: static parser successfully parsed marts/fct_customer_orders.sql
04:46:24.821536 [debug] [MainThread]: 1699: static parser successfully parsed marts/intermediate/int_orders.sql
04:46:24.825584 [debug] [MainThread]: 1699: static parser successfully parsed staging/jaffle_shop/stg_jaffle_shop__customers.sql
04:46:24.829278 [debug] [MainThread]: 1699: static parser successfully parsed staging/jaffle_shop/stg_jaffle_shop__orders.sql
04:46:24.833508 [debug] [MainThread]: 1699: static parser successfully parsed staging/stripe/stg_stripe__payments.sql
04:46:25.007266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd35584b0a0>]}
04:46:25.027268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd356121fa0>]}
04:46:25.028379 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 1 analysis, 405 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:46:25.031599 [info ] [MainThread]: 
04:46:25.033525 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:46:25.036286 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics"
04:46:25.058578 [debug] [ThreadPool]: Using snowflake connection "list_analytics"
04:46:25.059820 [debug] [ThreadPool]: On list_analytics: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics"} */

    show terse schemas in database analytics
    limit 10000
04:46:25.061425 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:46:25.972479 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.91 seconds
04:46:25.976757 [debug] [ThreadPool]: On list_analytics: Close
04:46:26.128295 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:46:26.141863 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:46:26.143346 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:46:26.145173 [debug] [ThreadPool]: Opening a new connection, currently in state closed
04:46:26.699837 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.55 seconds
04:46:26.704078 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:46:26.863179 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:46:26.865732 [info ] [MainThread]: 
04:46:26.874862 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.customer_orders
04:46:26.875356 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
04:46:26.875805 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
04:46:26.876217 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.stg_stripe__payments
04:46:26.876916 [info ] [Thread-1  ]: 1 of 6 START view model dbt_knguyen_refactor.customer_orders.................... [RUN]
04:46:26.878254 [info ] [Thread-2  ]: 2 of 6 START view model dbt_knguyen_refactor.stg_jaffle_shop__customers......... [RUN]
04:46:26.879319 [info ] [Thread-3  ]: 3 of 6 START view model dbt_knguyen_refactor.stg_jaffle_shop__orders............ [RUN]
04:46:26.880228 [info ] [Thread-4  ]: 4 of 6 START view model dbt_knguyen_refactor.stg_stripe__payments............... [RUN]
04:46:26.884233 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.customer_orders"
04:46:26.885154 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:46:26.886830 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:46:26.887793 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:46:26.889114 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.customer_orders
04:46:26.896545 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.customer_orders
04:46:26.893428 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
04:46:26.895045 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
04:46:26.891646 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
04:46:26.911592 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
04:46:26.908614 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
04:46:26.910026 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.stg_stripe__payments
04:46:26.908140 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.customer_orders"
04:46:26.917935 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:46:26.924655 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:46:26.929268 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:46:26.943876 [debug] [Thread-1  ]: finished collecting timing info
04:46:26.944781 [debug] [Thread-2  ]: finished collecting timing info
04:46:26.945542 [debug] [Thread-3  ]: finished collecting timing info
04:46:26.945863 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.customer_orders
04:46:26.946561 [debug] [Thread-4  ]: finished collecting timing info
04:46:26.948934 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
04:46:26.949562 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
04:46:26.962298 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
04:46:27.008161 [debug] [Thread-1  ]: Writing runtime SQL for node "model.dbt_refactoring.customer_orders"
04:46:27.009238 [debug] [Thread-2  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:46:27.020417 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:46:27.020913 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:46:27.035018 [debug] [Thread-2  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:46:27.039211 [debug] [Thread-1  ]: Using snowflake connection "model.dbt_refactoring.customer_orders"
04:46:27.041988 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:46:27.046802 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_stripe__payments"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_stripe__payments 
  
   as (
    with
source as (
    select * from raw.stripe.payment
),
transformed as (
    select
        id as payment_id,
        orderid as order_id,
        status as payment_status,
        round(amount / 100.0, 2) as payment_amount
    from source
)
select * from transformed
  );
04:46:27.043782 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.customer_orders 
  
   as (
    select 
    orders.id as order_id,
    orders.user_id as customer_id,
    last_name as surname,
    first_name as givenname,
    first_order_date,
    order_count,
    total_lifetime_value,
    round(amount/100.0,2) as order_value_dollars,
    orders.status as order_status,
    payments.status as payment_status
from raw.jaffle_shop.orders as orders

join (
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
) customers
on orders.user_id = customers.id

join (

    select 
        b.id as customer_id,
        b.name as full_name,
        b.last_name as surname,
        b.first_name as givenname,
        min(order_date) as first_order_date,
        min(case when a.status NOT IN ('returned','return_pending') then order_date end) as first_non_returned_order_date,
        max(case when a.status NOT IN ('returned','return_pending') then order_date end) as most_recent_non_returned_order_date,
        COALESCE(max(user_order_seq),0) as order_count,
        COALESCE(count(case when a.status != 'returned' then 1 end),0) as non_returned_order_count,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end) as total_lifetime_value,
        sum(case when a.status NOT IN ('returned','return_pending') then ROUND(c.amount/100.0,2) else 0 end)/NULLIF(count(case when a.status NOT IN ('returned','return_pending') then 1 end),0) as avg_non_returned_order_value,
        array_agg(distinct a.id) as order_ids

    from (
      select 
        row_number() over (partition by user_id order by order_date, id) as user_order_seq,
        *
      from raw.jaffle_shop.orders
    ) a

    join ( 
      select 
        first_name || ' ' || last_name as name, 
        * 
      from raw.jaffle_shop.customers
    ) b
    on a.user_id = b.id

    left outer join raw.stripe.payment c
    on a.id = c.orderid

    where a.status NOT IN ('pending') and c.status != 'fail'

    group by b.id, b.name, b.last_name, b.first_name

) customer_order_history
on orders.user_id = customer_order_history.customer_id

left outer join raw.stripe.payment payments
on orders.id = payments.orderid

where payments.status != 'fail'
  );
04:46:27.045916 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:46:27.042364 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__customers"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.customers
),
transformed as (
    select 
        id as customer_id,
        last_name as surname,
        first_name as givenname,
        first_name || ' ' || last_name as full_name, 
        * 
    from source
)
select * from transformed
  );
04:46:27.048389 [debug] [Thread-4  ]: Opening a new connection, currently in state init
04:46:27.049915 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
04:46:27.051519 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.stg_jaffle_shop__orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders 
  
   as (
    with
source as (
    select * from raw.jaffle_shop.orders
),
transformed as (
    select 
        id as order_id,
        user_id as customer_id,
        order_date,
        status as order_status,
        case 
            when order_status not in ('returned','return_pending') 
                then order_date 
        end as valid_order_date,
        row_number() over (
                        partition by user_id 
                        order by order_date, id) as user_order_seq
    from source
)
select * from transformed
  );
04:46:27.053004 [debug] [Thread-2  ]: Opening a new connection, currently in state init
04:46:27.065549 [debug] [Thread-3  ]: Opening a new connection, currently in state init
04:46:28.377775 [debug] [Thread-1  ]: SQL status: SUCCESS 1 in 1.33 seconds
04:46:28.399068 [debug] [Thread-1  ]: finished collecting timing info
04:46:28.401118 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 1.35 seconds
04:46:28.401782 [debug] [Thread-1  ]: On model.dbt_refactoring.customer_orders: Close
04:46:28.405533 [debug] [Thread-4  ]: finished collecting timing info
04:46:28.417235 [debug] [Thread-4  ]: On model.dbt_refactoring.stg_stripe__payments: Close
04:46:28.425298 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 1.36 seconds
04:46:28.429199 [debug] [Thread-3  ]: finished collecting timing info
04:46:28.430246 [debug] [Thread-3  ]: On model.dbt_refactoring.stg_jaffle_shop__orders: Close
04:46:28.450021 [debug] [Thread-2  ]: SQL status: SUCCESS 1 in 1.4 seconds
04:46:28.453488 [debug] [Thread-2  ]: finished collecting timing info
04:46:28.454387 [debug] [Thread-2  ]: On model.dbt_refactoring.stg_jaffle_shop__customers: Close
04:46:28.575781 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3549d0160>]}
04:46:28.577586 [info ] [Thread-3  ]: 3 of 6 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__orders....... [[32mSUCCESS 1[0m in 1.69s]
04:46:28.579867 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
04:46:28.581174 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd35449ceb0>]}
04:46:28.583788 [info ] [Thread-1  ]: 1 of 6 OK created view model dbt_knguyen_refactor.customer_orders............... [[32mSUCCESS 1[0m in 1.70s]
04:46:28.587135 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.customer_orders
04:46:28.589887 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3544390a0>]}
04:46:28.592052 [info ] [Thread-4  ]: 4 of 6 OK created view model dbt_knguyen_refactor.stg_stripe__payments.......... [[32mSUCCESS 1[0m in 1.70s]
04:46:28.594053 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
04:46:28.596148 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.int_orders
04:46:28.597799 [info ] [Thread-3  ]: 5 of 6 START view model dbt_knguyen_refactor.int_orders......................... [RUN]
04:46:28.600049 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.int_orders"
04:46:28.600907 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.int_orders
04:46:28.603924 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.int_orders
04:46:28.609761 [debug] [Thread-2  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3549d01f0>]}
04:46:28.615084 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.int_orders"
04:46:28.629482 [info ] [Thread-2  ]: 2 of 6 OK created view model dbt_knguyen_refactor.stg_jaffle_shop__customers.... [[32mSUCCESS 1[0m in 1.72s]
04:46:28.669070 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
04:46:28.671994 [debug] [Thread-3  ]: finished collecting timing info
04:46:28.689262 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.int_orders
04:46:28.698649 [debug] [Thread-3  ]: Writing runtime SQL for node "model.dbt_refactoring.int_orders"
04:46:28.754840 [debug] [Thread-3  ]: Using snowflake connection "model.dbt_refactoring.int_orders"
04:46:28.755915 [debug] [Thread-3  ]: On model.dbt_refactoring.int_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.int_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.int_orders 
  
   as (
    with 

-- Import CTEs
orders as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__orders
),
payments as (
    select * from analytics.dbt_knguyen_refactor.stg_stripe__payments
    where payment_status != 'fail'
),
-----------
order_totals as (
    select
        order_id,
        payment_status,
        sum(payment_amount) as order_value_dollars
    from payments
    group by 1, 2
),
order_value_joined as (
    select
        orders.*,
        order_totals.payment_status,
        order_totals.order_value_dollars
    from orders
    left join order_totals
        on orders.order_id = order_totals.order_id
)
select * from order_value_joined
  );
04:46:28.758289 [debug] [Thread-3  ]: Opening a new connection, currently in state closed
04:46:29.470681 [debug] [Thread-3  ]: SQL status: SUCCESS 1 in 0.71 seconds
04:46:29.475413 [debug] [Thread-3  ]: finished collecting timing info
04:46:29.476623 [debug] [Thread-3  ]: On model.dbt_refactoring.int_orders: Close
04:46:29.622953 [debug] [Thread-3  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3549cad90>]}
04:46:29.624636 [info ] [Thread-3  ]: 5 of 6 OK created view model dbt_knguyen_refactor.int_orders.................... [[32mSUCCESS 1[0m in 1.02s]
04:46:29.626738 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.int_orders
04:46:29.629701 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.fct_customer_orders
04:46:29.631089 [info ] [Thread-4  ]: 6 of 6 START view model dbt_knguyen_refactor.fct_customer_orders................ [RUN]
04:46:29.633537 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:46:29.635312 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
04:46:29.637584 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.fct_customer_orders
04:46:29.645513 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
04:46:29.648901 [debug] [Thread-4  ]: finished collecting timing info
04:46:29.649755 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.fct_customer_orders
04:46:29.654486 [debug] [Thread-4  ]: Writing runtime SQL for node "model.dbt_refactoring.fct_customer_orders"
04:46:29.663487 [debug] [Thread-4  ]: Using snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:46:29.664499 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "model.dbt_refactoring.fct_customer_orders"} */

  create or replace  view analytics.dbt_knguyen_refactor.fct_customer_orders 
  
   as (
    with 

-- Import CTEs
customers as (
    select * from analytics.dbt_knguyen_refactor.stg_jaffle_shop__customers
),
orders as (
    select * from analytics.dbt_knguyen_refactor.int_orders
),
-----------
customer_orders as (
    select
        orders.*,
        customers.full_name,
        customers.surname,
        customers.givenname,

        ---Customer level aggregations
        min(orders.order_date) over(
            partition by orders.customer_id
        ) as customer_first_order_date,

        min(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_first_non_returned_order_date,
        
        max(orders.valid_order_date) over(
            partition by orders.customer_id
        ) as customer_most_recent_non_returned_order_date,
        
        count(*) over(
            partition by orders.customer_id
        ) as customer_order_count,

        sum(nvl2(orders.valid_order_date, 1, 0)) over(
            partition by orders.customer_id
        ) as customer_non_returned_order_count,

        sum(nvl2(orders.valid_order_date, orders.order_value_dollars, 0)) over(
            partition by orders.customer_id
        ) as customer_total_lifetime_value,

        array_agg(distinct orders.order_id) over(
            partition by orders.customer_id
        ) as customer_order_ids

    from orders
    inner join customers
        on orders.customer_id = customers.customer_id
),
add_avg_order_values as (
    select 
        *,
        customer_total_lifetime_value / customer_non_returned_order_count 
            as customer_avg_non_returned_order_value
    from customer_orders
),
-----------

-- Final CTE
final as (
    select 
        order_id,
        customer_id,
        surname,
        givenname,
        customer_first_order_date as first_order_date,
        customer_order_count as order_count,
        customer_total_lifetime_value as total_lifetime_value,
        order_value_dollars,
        order_status,
        payment_status
    from add_avg_order_values

)
-- Simple Select statement
select * from final
  );
04:46:29.666407 [debug] [Thread-4  ]: Opening a new connection, currently in state closed
04:46:30.586489 [debug] [Thread-4  ]: SQL status: SUCCESS 1 in 0.92 seconds
04:46:30.590391 [debug] [Thread-4  ]: finished collecting timing info
04:46:30.591505 [debug] [Thread-4  ]: On model.dbt_refactoring.fct_customer_orders: Close
04:46:30.736142 [debug] [Thread-4  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '95221391-fdfa-43e9-8052-05bed00f159b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd354417550>]}
04:46:30.738073 [info ] [Thread-4  ]: 6 of 6 OK created view model dbt_knguyen_refactor.fct_customer_orders........... [[32mSUCCESS 1[0m in 1.10s]
04:46:30.740204 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.fct_customer_orders
04:46:30.744265 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:46:30.745432 [info ] [MainThread]: 
04:46:30.747363 [info ] [MainThread]: Finished running 6 view models in 5.71s.
04:46:30.748741 [debug] [MainThread]: Connection 'master' was properly closed.
04:46:30.751327 [debug] [MainThread]: Connection 'model.dbt_refactoring.customer_orders' was properly closed.
04:46:30.753550 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_jaffle_shop__customers' was properly closed.
04:46:30.755412 [debug] [MainThread]: Connection 'model.dbt_refactoring.int_orders' was properly closed.
04:46:30.757503 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
04:46:30.786928 [info ] [MainThread]: 
04:46:30.788398 [info ] [MainThread]: [32mCompleted successfully[0m
04:46:30.791932 [info ] [MainThread]: 
04:46:30.793561 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=0 SKIP=0 TOTAL=6
04:46:30.798321 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd356121190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd356121670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd3543c6cd0>]}


============================== 2022-04-21 04:48:58.620849 | f185f852-9372-471c-8988-33248a7c91a0 ==============================
04:48:58.620849 [info ] [MainThread]: Running with dbt=1.0.4
04:48:58.624214 [debug] [MainThread]: running dbt with arguments Namespace(record_timing_info=None, debug=None, log_format=None, write_json=None, use_colors=None, printer_width=None, warn_error=None, version_check=None, partial_parse=None, single_threaded=False, use_experimental_parser=None, static_parser=None, profiles_dir='/root/.dbt', send_anonymous_usage_stats=None, fail_fast=None, event_buffer_size=None, project_dir=None, profile=None, target=None, vars='{}', log_cache_events=False, parse_only=False, threads=None, select=None, exclude=None, selector_name=None, state=None, full_refresh=False, defer=None, cls=<class 'dbt.task.compile.CompileTask'>, which='compile', rpc_method='compile')
04:48:58.625875 [debug] [MainThread]: Tracking: tracking
04:48:58.627579 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f561736cd30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f561736c190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f561736caf0>]}
04:48:58.833106 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
04:48:58.834063 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
04:48:58.845809 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f185f852-9372-471c-8988-33248a7c91a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56161650d0>]}
04:48:58.870876 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f185f852-9372-471c-8988-33248a7c91a0', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56161bb160>]}
04:48:58.872321 [info ] [MainThread]: Found 6 models, 0 tests, 0 snapshots, 1 analysis, 405 macros, 0 operations, 0 seed files, 3 sources, 0 exposures, 0 metrics
04:48:58.876225 [info ] [MainThread]: 
04:48:58.878483 [debug] [MainThread]: Acquiring new snowflake connection "master"
04:48:58.881654 [debug] [ThreadPool]: Acquiring new snowflake connection "list_analytics_dbt_knguyen_refactor"
04:48:58.901758 [debug] [ThreadPool]: Using snowflake connection "list_analytics_dbt_knguyen_refactor"
04:48:58.903362 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "connection_name": "list_analytics_dbt_knguyen_refactor"} */

    show terse objects in analytics.dbt_knguyen_refactor
04:48:58.906056 [debug] [ThreadPool]: Opening a new connection, currently in state init
04:48:59.815031 [debug] [ThreadPool]: SQL status: SUCCESS 6 in 0.91 seconds
04:48:59.819677 [debug] [ThreadPool]: On list_analytics_dbt_knguyen_refactor: Close
04:48:59.975862 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
04:48:59.978682 [info ] [MainThread]: 
04:48:59.990052 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.customer_orders
04:48:59.990434 [debug] [Thread-2  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__customers
04:48:59.990836 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.stg_jaffle_shop__orders
04:48:59.991114 [debug] [Thread-4  ]: Began running node model.dbt_refactoring.stg_stripe__payments
04:48:59.992294 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.customer_orders"
04:48:59.994690 [debug] [Thread-2  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__customers"
04:48:59.996579 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_jaffle_shop__orders"
04:48:59.998122 [debug] [Thread-4  ]: Acquiring new snowflake connection "model.dbt_refactoring.stg_stripe__payments"
04:48:59.999137 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.customer_orders
04:49:00.001224 [debug] [Thread-2  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__customers
04:49:00.002880 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.stg_jaffle_shop__orders
04:49:00.005157 [debug] [Thread-4  ]: Began compiling node model.dbt_refactoring.stg_stripe__payments
04:49:00.006939 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.customer_orders
04:49:00.008534 [debug] [Thread-2  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__customers
04:49:00.009990 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.stg_jaffle_shop__orders
04:49:00.012352 [debug] [Thread-4  ]: Compiling model.dbt_refactoring.stg_stripe__payments
04:49:00.023375 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.customer_orders"
04:49:00.027907 [debug] [Thread-2  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__customers"
04:49:00.032504 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.stg_jaffle_shop__orders"
04:49:00.036288 [debug] [Thread-4  ]: Writing injected SQL for node "model.dbt_refactoring.stg_stripe__payments"
04:49:00.040984 [debug] [Thread-1  ]: finished collecting timing info
04:49:00.044762 [debug] [Thread-2  ]: finished collecting timing info
04:49:00.045121 [debug] [Thread-3  ]: finished collecting timing info
04:49:00.055215 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.customer_orders
04:49:00.057443 [debug] [Thread-4  ]: finished collecting timing info
04:49:00.058501 [debug] [Thread-2  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__customers
04:49:00.062519 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.stg_jaffle_shop__orders
04:49:00.064629 [debug] [Thread-1  ]: finished collecting timing info
04:49:00.066093 [debug] [Thread-4  ]: Began executing node model.dbt_refactoring.stg_stripe__payments
04:49:00.067596 [debug] [Thread-2  ]: finished collecting timing info
04:49:00.068651 [debug] [Thread-3  ]: finished collecting timing info
04:49:00.070942 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.customer_orders
04:49:00.071728 [debug] [Thread-4  ]: finished collecting timing info
04:49:00.073853 [debug] [Thread-2  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__customers
04:49:00.075091 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.stg_jaffle_shop__orders
04:49:00.078522 [debug] [Thread-4  ]: Finished running node model.dbt_refactoring.stg_stripe__payments
04:49:00.082640 [debug] [Thread-1  ]: Began running node model.dbt_refactoring.int_orders
04:49:00.083727 [debug] [Thread-1  ]: Acquiring new snowflake connection "model.dbt_refactoring.int_orders"
04:49:00.084418 [debug] [Thread-1  ]: Began compiling node model.dbt_refactoring.int_orders
04:49:00.085536 [debug] [Thread-1  ]: Compiling model.dbt_refactoring.int_orders
04:49:00.090575 [debug] [Thread-1  ]: Writing injected SQL for node "model.dbt_refactoring.int_orders"
04:49:00.094114 [debug] [Thread-1  ]: finished collecting timing info
04:49:00.095101 [debug] [Thread-1  ]: Began executing node model.dbt_refactoring.int_orders
04:49:00.096402 [debug] [Thread-1  ]: finished collecting timing info
04:49:00.097995 [debug] [Thread-1  ]: Finished running node model.dbt_refactoring.int_orders
04:49:00.099491 [debug] [Thread-3  ]: Began running node model.dbt_refactoring.fct_customer_orders
04:49:00.100330 [debug] [Thread-3  ]: Acquiring new snowflake connection "model.dbt_refactoring.fct_customer_orders"
04:49:00.101150 [debug] [Thread-3  ]: Began compiling node model.dbt_refactoring.fct_customer_orders
04:49:00.102360 [debug] [Thread-3  ]: Compiling model.dbt_refactoring.fct_customer_orders
04:49:00.108464 [debug] [Thread-3  ]: Writing injected SQL for node "model.dbt_refactoring.fct_customer_orders"
04:49:00.112371 [debug] [Thread-3  ]: finished collecting timing info
04:49:00.113294 [debug] [Thread-3  ]: Began executing node model.dbt_refactoring.fct_customer_orders
04:49:00.117715 [debug] [Thread-3  ]: finished collecting timing info
04:49:00.119811 [debug] [Thread-3  ]: Finished running node model.dbt_refactoring.fct_customer_orders
04:49:00.121624 [debug] [Thread-2  ]: Began running node analysis.dbt_refactoring.audit_compare
04:49:00.122645 [debug] [Thread-2  ]: Acquiring new snowflake connection "analysis.dbt_refactoring.audit_compare"
04:49:00.123858 [debug] [Thread-2  ]: Began compiling node analysis.dbt_refactoring.audit_compare
04:49:00.125157 [debug] [Thread-2  ]: Compiling analysis.dbt_refactoring.audit_compare
04:49:00.149061 [debug] [Thread-2  ]: Using snowflake connection "analysis.dbt_refactoring.audit_compare"
04:49:00.150341 [debug] [Thread-2  ]: On analysis.dbt_refactoring.audit_compare: /* {"app": "dbt", "dbt_version": "1.0.4", "profile_name": "dbt-refactoring", "target_name": "dev", "node_id": "analysis.dbt_refactoring.audit_compare"} */

    describe table "ANALYTICS"."DBT_KNGUYEN_REFACTOR"."CUSTOMER_ORDERS"
04:49:00.152100 [debug] [Thread-2  ]: Opening a new connection, currently in state init
04:49:00.917106 [debug] [Thread-2  ]: SQL status: SUCCESS 10 in 0.76 seconds
04:49:00.965347 [debug] [Thread-2  ]: Writing injected SQL for node "analysis.dbt_refactoring.audit_compare"
04:49:00.974401 [debug] [Thread-2  ]: finished collecting timing info
04:49:00.975604 [debug] [Thread-2  ]: Began executing node analysis.dbt_refactoring.audit_compare
04:49:00.977003 [debug] [Thread-2  ]: finished collecting timing info
04:49:00.978572 [debug] [Thread-2  ]: On analysis.dbt_refactoring.audit_compare: Close
04:49:01.122548 [debug] [Thread-2  ]: Finished running node analysis.dbt_refactoring.audit_compare
04:49:01.126231 [debug] [MainThread]: Connection 'master' was properly closed.
04:49:01.127417 [debug] [MainThread]: Connection 'model.dbt_refactoring.int_orders' was properly closed.
04:49:01.129024 [debug] [MainThread]: Connection 'analysis.dbt_refactoring.audit_compare' was properly closed.
04:49:01.130372 [debug] [MainThread]: Connection 'model.dbt_refactoring.fct_customer_orders' was properly closed.
04:49:01.131617 [debug] [MainThread]: Connection 'model.dbt_refactoring.stg_stripe__payments' was properly closed.
04:49:01.148825 [info ] [MainThread]: Done.
04:49:01.150077 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56153a8400>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56160c40d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f56161b45e0>]}
